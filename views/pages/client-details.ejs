<%- include('../partials/header') %>

<div class="dashboard-container">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <div class="section-header">
            <h1><i class="fas fa-user"></i> Detalhes do Aluno: <%= clientData.name %></h1>
            <a href="javascript:history.back()" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
        </div>

        <% if (typeof showAdminOptions !== 'undefined' && showAdminOptions) { %>
        <div class="content-card" style="margin-bottom: 2rem; border: 1px solid #444; background: #1a1a1a;">
            <h3 style="color: var(--c-accent-primary); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
                <i class="fas fa-user-shield"></i> Gestão Administrativa
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <form action="/superadmin/assign-trainer" method="POST">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="user_id" value="<%= clientData.id %>">
                        <label style="display:block; margin-bottom:5px; color:#ccc;">Atribuir Personal:</label>
                        <div style="display: flex; gap: 10px;">
                            <select name="trainer_id" class="form-control" style="padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; flex-grow: 1;">
                                <option value="">Sem Personal</option>
                                <% if(typeof trainers !== "undefined") { %>
                                    <% trainers.forEach(t => { %>
                                        <option value="<%= t.id %>" <%= clientData.trainer_id === t.id ? "selected" : "" %>><%= t.name %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm">Salvar</button>
                        </div>
                    </form>
                </div>
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <form action="/superadmin/toggle-status" method="POST" style="margin: 0;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="user_id" value="<%= clientData.id %>">
                        <input type="hidden" name="status" value="<%= clientData.status === "active" ? "suspended" : "active" %>">
                        <button type="submit" class="btn <%= clientData.status === "active" ? "btn-warning" : "btn-success" %> btn-sm">
                            <i class="fas fa-power-off"></i> <%= clientData.status === "active" ? "Suspender" : "Ativar" %>
                        </button>
                    </form>
                    <form action="/superadmin/delete-user" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este usuário permanentemente?');" style="margin: 0;">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="user_id" value="<%= clientData.id %>">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <% } %>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Treinos Realizados</h3>
                <div class="value"><%= stats.completed_workouts || 0 %></div>
            </div>
            <div class="stat-card">
                <h3>Check-ins</h3>
                <div class="value"><%= stats.total_checkins || 0 %></div>
            </div>
            <div class="stat-card">
                <h3>Sequência Atual</h3>
                <div class="value"><%= stats.current_streak || 0 %> dias</div>
            </div>
        </div>

        <div class="content-card" style="margin-top: 2rem;">
            <h3 style="color: white; border-bottom: 1px solid #333; padding-bottom: 1rem; margin-bottom: 1rem;">
                <i class="fas fa-file-medical-alt"></i> Ficha de Anamnese e Perfil Completo
            </h3>
            
            <% if (typeof detailedProfile !== 'undefined' && detailedProfile && detailedProfile.user_id) { %>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    
                    <div>
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Dados Pessoais</h4>
                        <p><strong>Idade:</strong> <%= detailedProfile.age || '--' %> anos</p>
                        <p><strong>Telefone:</strong> <%= detailedProfile.phone || '--' %></p>
                        <p><strong>Gênero:</strong> <%= detailedProfile.gender_identity || '--' %></p>
                        <p><strong>Profissão:</strong> <%= detailedProfile.occupation || '--' %></p>
                    </div>

                    <div>
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Corpo e Medidas</h4>
                        <p><strong>Peso:</strong> <%= detailedProfile.weight || '--' %> kg</p>
                        <p><strong>Altura:</strong> <%= detailedProfile.height || '--' %> m</p>
                        <p><strong>Gordura Corporal:</strong> <%= detailedProfile.body_fat || '--' %> %</p>
                    </div>

                    <div>
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Saúde</h4>
                        <p><strong>Condições Médicas:</strong> <%= detailedProfile.medical_conditions || 'Nenhuma' %></p>
                        <p><strong>Lesões:</strong> <%= detailedProfile.injuries || 'Nenhuma' %></p>
                        <p><strong>Medicamentos:</strong> <%= detailedProfile.medications || 'Nenhum' %></p>
                        <p><strong>Fumante:</strong> <%= detailedProfile.smoking === 'true' ? 'Sim' : 'Não' %></p>
                        <p><strong>Álcool:</strong> <%= detailedProfile.alcohol || 'Não informado' %></p>
                    </div>

                    <div>
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Objetivos</h4>
                        <p><strong>Principal:</strong> <%= detailedProfile.main_goal || '--' %></p>
                        <p><strong>Prazo/Evento:</strong> <%= detailedProfile.specific_event || '--' %></p>
                        <p><strong>Motivação:</strong> <%= detailedProfile.motivation_level || '--' %>/10</p>
                    </div>

                    <div style="grid-column: 1 / -1; border-top: 1px solid #333; padding-top: 1rem;">
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Histórico e Preferências de Treino</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <p><strong>Experiência:</strong> <%= detailedProfile.training_experience || '--' %></p>
                            <p><strong>Dias Disponíveis:</strong> <%= detailedProfile.training_days_available || '--' %></p>
                            <p><strong>Horário Preferido:</strong> <%= detailedProfile.training_time || '--' %></p>
                            <p><strong>Local/Equipamentos:</strong> <%= detailedProfile.equipment_available || '--' %></p>
                        </div>
                    </div>

                    <div style="grid-column: 1 / -1; border-top: 1px solid #333; padding-top: 1rem;">
                        <h4 style="color: var(--c-accent-primary); margin-bottom: 0.5rem; font-size: 1rem;">Nutrição e Rotina</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <p><strong>Refeições/dia:</strong> <%= detailedProfile.meal_frequency || '--' %></p>
                            <p><strong>Água (litros):</strong> <%= detailedProfile.water_intake || '--' %></p>
                            <p><strong>Horas de Sono:</strong> <%= detailedProfile.sleep_hours || '--' %></p>
                            <p><strong>Nível de Estresse:</strong> <%= detailedProfile.stress_level || '--' %></p>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <p style="color: #888; font-style: italic; padding: 1rem;">
                    Nenhuma ficha de anamnese foi preenchida para este aluno.
                </p>
            <% } %>
        </div>

        <div class="content-card" style="margin-top: 2rem;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Treinos Atribuídos</h2>
                <a href="/workouts/create?client_id=<%= clientData.id %>" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Novo Treino
                </a>
            </div>

            <% if (workouts && workouts.length > 0) { %>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Dia</th>
                                <th>Exercícios</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% workouts.forEach(workout => { %>
                                <tr>
                                    <td><%= workout.title %></td>
                                    <td><%= workout.day_of_week || '--' %></td>
                                    <td><%= workout.exercises ? workout.exercises.length : 0 %></td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="/workouts/edit/<%= workout.id %>" class="btn-icon" title="Editar"><i class="fas fa-edit"></i></a>
                                            <form action="/workouts/delete/<%= workout.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Excluir treino?');">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <button type="submit" class="btn-icon delete" title="Excluir"><i class="fas fa-trash"></i></button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <p class="empty-state">Nenhum treino atribuído ainda.</p>
            <% } %>
        </div>

    </main>
</div>
<%- include('../partials/footer') %>
