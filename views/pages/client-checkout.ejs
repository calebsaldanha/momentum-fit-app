<%- include('../partials/header') %>
<div class="dashboard-container">
    <%- include('../partials/sidebar') %>
    
    <main class="main-content">
        <div class="page-header">
            <h1>Finalizar Assinatura</h1>
            <% if (plan) { %>
                <p>Plano Selecionado: <strong><%= plan.name %></strong></p>
            <% } else { %>
                <p>Plano Selecionado: <strong>Desconhecido</strong></p>
            <% } %>
        </div>

        <% if (messages && messages.error) { %>
            <div class="alert alert-danger"><%= messages.error %></div>
        <% } %>

        <% if (plan) { %>
        <div class="checkout-grid">
            <div class="card plan-summary">
                <h3>Resumo</h3>
                <div class="price-tag">R$ <%= plan.price %> <span class="period">/mês</span></div>
                <ul class="features-list">
                    <li>✅ Acesso à plataforma</li>
                    <li>✅ Treinos personalizados</li>
                    <li>✅ Suporte via Chat e IA</li>
                </ul>
            </div>

            <div class="card payment-details">
                <h3>Pagamento via PIX</h3>
                <p>Use o QR Code ou a chave abaixo.</p>
                
                <div style="text-align: center; margin: 20px 0;">
                    <% if (typeof pixKey !== 'undefined') { %>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=<%= pixKey %>" alt="QR Code" style="border: 2px solid #eee; padding: 10px; border-radius: 8px;">
                    <% } %>
                </div>

                <div class="form-group">
                    <label>Chave Pix:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" value="<%= typeof pixKey !== 'undefined' ? pixKey : '' %>" id="pixKeyInput" readonly class="form-control">
                        <button type="button" onclick="copyPix()" class="btn-secondary">Copiar</button>
                    </div>
                </div>

                <hr>

                <form action="/client/checkout" method="POST">
                    <input type="hidden" name="plan_id" value="<%= plan.id %>">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                    
                    <div class="form-group">
                        <label>Dia de vencimento:</label>
                        <select name="due_day" required>
                            <option value="5">Dia 05</option>
                            <option value="10">Dia 10</option>
                            <option value="15">Dia 15</option>
                            <option value="20">Dia 20</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-primary btn-block">Confirmar Pagamento Enviado</button>
                </form>
            </div>
        </div>
        <% } else { %>
            <div class="alert alert-warning">
                Erro ao carregar detalhes do plano. <a href="/client/plans">Voltar aos planos</a>.
            </div>
        <% } %>
    </main>
</div>

<script>
    function copyPix() {
        var copyText = document.getElementById("pixKeyInput");
        if(copyText) {
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("Chave copiada!");
        }
    }
</script>
<%- include('../partials/footer') %>
