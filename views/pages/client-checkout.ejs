<%- include('../partials/header') %>
<div class="dashboard-container">
    <%- include('../partials/sidebar') %>
    
    <main class="main-content">
        <div class="checkout-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
            <div style="font-size: 3rem; margin-bottom: 10px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 style="margin: 0; font-weight: 700; color: white;">Cadastro Recebido!</h2>
            <p style="margin: 10px 0 0; opacity: 0.9; color: #e0f2f1;">Você está a um passo de transformar sua rotina.</p>
        </div>

        <div class="page-header">
            <h1>Ativação da Assinatura</h1>
            <p style="color: #a0a0a0;">Confirme os detalhes e realize o pagamento para liberar seu acesso.</p>
        </div>

        <% if (messages && messages.error) { %>
            <div class="alert alert-danger"><%= messages.error %></div>
        <% } %>
        <% if (messages && messages.success) { %>
            <div class="alert alert-success"><%= messages.success %></div>
        <% } %>

        <% if (plan) { %>
        <div class="checkout-grid" style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem;">
            
            <div class="card-box" style="height: fit-content;">
                <div style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-light); padding-bottom: 1rem;">
                    <h3 style="margin: 0; color: white;">Resumo do Pedido</h3>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="planSelector" style="display: block; margin-bottom: 8px; color: #a0a0a0;">Plano Selecionado:</label>
                    <select id="planSelector" class="form-control" onchange="window.location.href='/client/checkout/'+this.value" 
                            style="width: 100%; padding: 10px; background: #000; color: white; border: 1px solid #333; border-radius: 6px;">
                        <% if (typeof allPlans !== 'undefined') { %>
                            <% allPlans.forEach(p => { %>
                                <option value="<%= p.id %>" <%= p.id === plan.id ? 'selected' : '' %>>
                                    <%= p.name %> - R$ <%= p.price %>/mês
                                </option>
                            <% }); %>
                        <% } else { %>
                            <option selected><%= plan.name %></option>
                        <% } %>
                    </select>
                </div>

                <div class="card-body">
                    <h2 style="color: var(--primary-color); font-size: 2rem; margin: 0 0 0.5rem;">
                        <%= plan.name %>
                    </h2>
                    <div class="price-tag" style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 1.5rem;">
                        R$ <%= plan.price %> <span style="font-size: 0.875rem; font-weight: 400; color: #888;">/mês</span>
                    </div>
                    
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: center; color: #ccc;">
                            <i class="fas fa-check" style="color: var(--primary-color); margin-right: 10px;"></i> Acesso à plataforma
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: center; color: #ccc;">
                            <i class="fas fa-check" style="color: var(--primary-color); margin-right: 10px;"></i> Treinos personalizados
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: center; color: #ccc;">
                            <i class="fas fa-check" style="color: var(--primary-color); margin-right: 10px;"></i> Avaliação IA
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card-box">
                <div style="border-bottom: 1px solid var(--border-light); margin-bottom: 20px; padding-bottom: 10px;">
                    <h3 style="display: flex; align-items: center; gap: 10px; margin: 0; color: white;">
                        <i class="fas fa-qrcode" style="color: var(--primary-color);"></i>
                        <% if (parseFloat(plan.price) > 0) { %>
                            Pagamento via PIX
                        <% } else { %>
                            Ativação Gratuita
                        <% } %>
                    </h3>
                </div>

                <div class="payment-body" style="text-align: center;">
                    <% if (parseFloat(plan.price) > 0) { %>
                        <div class="alert" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; text-align: left;">
                            <strong>Instruções:</strong>
                            <ol style="margin: 5px 0 0 20px; padding: 0;">
                                <li>Abra o app do seu banco.</li>
                                <li>Escolha <strong>Pix > Pagar com QR Code</strong>.</li>
                                <li>Escaneie o código ou copie a chave.</li>
                            </ol>
                        </div>

                        <div class="qr-container" style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 20px 0;">
                            <% if (typeof pixPayload !== 'undefined' && pixPayload) { %>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=<%= encodeURIComponent(pixPayload) %>" 
                                     alt="QR Code Pix" style="display: block; max-width: 100%;">
                            <% } else { %>
                                <p style="color: #333;">Erro ao gerar QR Code</p>
                            <% } %>
                        </div>
                        
                        <p style="color: #ccc; margin-bottom: 20px;">Valor a pagar: <strong style="color: white; font-size: 1.2rem;">R$ <%= plan.price %></strong></p>

                        <div class="form-group" style="text-align: left; background: #1a1a1a; padding: 15px; border-radius: 8px;">
                            <label style="font-size: 0.85rem; font-weight: 600; color: #a0a0a0; margin-bottom: 8px; display: block;">
                                Pix Copia e Cola:
                            </label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <input type="text" 
                                       value="<%= (typeof pixPayload !== 'undefined' && pixPayload) ? pixPayload : (typeof pixKey !== 'undefined' ? pixKey : '') %>" 
                                       id="pixKeyInput" 
                                       readonly 
                                       style="flex: 1; background: #000; border: 1px solid #333; color: #888; padding: 10px; border-radius: 6px; font-family: monospace;">
                                <button type="button" onclick="copyPix()" class="btn btn-primary" style="white-space: nowrap;">
                                    <i class="fas fa-copy"></i> Copiar
                                </button>
                            </div>
                        </div>
                    <% } else { %>
                        <div style="padding: 40px; text-align: center;">
                            <i class="fas fa-gift" style="font-size: 4rem; color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3 style="color: white;">Este plano é gratuito!</h3>
                            <p style="color: #aaa;">Não é necessário pagamento. Basta clicar abaixo para ativar.</p>
                        </div>
                    <% } %>

                    <hr style="border-color: var(--border-light); margin: 30px 0;">

                    <form action="/client/checkout" method="POST" style="text-align: left;">
                        <input type="hidden" name="plan_id" value="<%= plan.id %>">
                        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                        
                        <% if (parseFloat(plan.price) > 0) { %>
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="font-weight: 600; color: #ccc; display: block; margin-bottom: 10px;">Dia de vencimento das próximas faturas:</label>
                                <div style="position: relative; max-width: 200px;">
                                    <select name="due_day" required class="form-control" style="width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; appearance: none;">
                                        <option value="5">Dia 05</option>
                                        <option value="10" selected>Dia 10</option>
                                        <option value="15">Dia 15</option>
                                        <option value="20">Dia 20</option>
                                    </select>
                                    <i class="fas fa-chevron-down" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;"></i>
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">A primeira cobrança é referente ao acesso imediato.</small>
                            </div>
                        <% } %>

                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 10px;">
                            <% if (parseFloat(plan.price) > 0) { %>
                                <i class="fas fa-check"></i> JÁ FIZ O PIX, LIBERAR ACESSO
                            <% } else { %>
                                <i class="fas fa-check"></i> ATIVAR PLANO AGORA
                            <% } %>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <% } else { %>
            <div class="alert alert-warning">
                Erro ao carregar detalhes do plano. <a href="/client/plans">Voltar aos planos</a>.
            </div>
        <% } %>
    </main>
</div>

<style>
    @media (max-width: 768px) {
        .checkout-grid {
            grid-template-columns: 1fr !important;
        }
        .checkout-header h2 {
            font-size: 1.5rem;
        }
        .price-tag {
            font-size: 2rem !important;
        }
    }
</style>

<script>
    function copyPix() {
        var copyText = document.getElementById("pixKeyInput");
        if(copyText) {
            copyText.select();
            copyText.setSelectionRange(0, 99999); /* Para mobile */
            
            navigator.clipboard.writeText(copyText.value).then(function() {
                const btn = document.querySelector('button[onclick="copyPix()"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                }, 2000);
            }, function(err) {
                alert("Erro ao copiar. Tente selecionar manualmente.");
            });
        }
    }
</script>
<%- include('../partials/footer') %>
