<%- include('../partials/header.ejs') %>

<style>
    .exercise-card {
        background: #111;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        transition: 0.3s;
    }
    .exercise-card.completed {
        border-color: var(--primary-color);
        background: rgba(190, 242, 2, 0.02);
    }
    .exercise-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    .exercise-title { font-size: 1.1rem; color: white; font-weight: 600; }
    .exercise-meta { display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; }
    
    .input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        background: #000;
        padding: 10px;
        border-radius: 8px;
    }
    .input-group label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 4px; }
    .input-group input { 
        width: 100%; background: #222; border: 1px solid #333; 
        color: white; padding: 8px; border-radius: 4px; text-align: center;
    }
    .check-btn {
        width: 40px; height: 40px;
        border-radius: 50%;
        border: 2px solid #333;
        background: transparent;
        color: transparent;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .check-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: #000;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.8);
        display: none; align-items: center; justify-content: center; z-index: 2000;
        backdrop-filter: blur(5px);
    }
    .modal-box {
        background: #111; border: 1px solid #333; padding: 30px;
        border-radius: 16px; width: 90%; max-width: 400px; text-align: center;
    }
    .rating-stars { font-size: 1.5rem; color: #444; cursor: pointer; margin: 15px 0; }
    .rating-stars i:hover, .rating-stars i.active { color: var(--primary-color); }
</style>

<div class="container" style="padding-top: 20px; padding-bottom: 80px;">
    
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <a href="/client/dashboard" class="text-muted"><i class="fas fa-arrow-left"></i> Voltar</a>
        <h2 style="font-size: 1.2rem; margin: 0;"><%= workout.title %></h2>
    </div>

    <form id="workoutForm">
        <% exercises.forEach((ex, index) => { %>
        <div class="exercise-card" id="card-<%= ex.id %>">
            <div class="exercise-header">
                <div>
                    <h3 class="exercise-title"><%= index + 1 %>. <%= ex.name %></h3>
                    <% if (ex.notes) { %>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 5px;"><i class="fas fa-info-circle"></i> <%= ex.notes %></p>
                    <% } %>
                </div>
                <button type="button" class="check-btn" onclick="toggleComplete(<%= ex.id %>)">
                    <i class="fas fa-check"></i>
                </button>
            </div>

            <div class="exercise-meta">
                <span><i class="fas fa-layer-group"></i> <%= ex.sets %> Séries</span>
                <span><i class="fas fa-redo"></i> <%= ex.reps %> Reps</span>
                <% if(ex.weight) { %> <span><i class="fas fa-weight-hanging"></i> <%= ex.weight %></span> <% } %>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Carga Real (kg)</label>
                    <input type="text" name="logs[<%= ex.id %>][weight]" placeholder="<%= ex.weight || '0' %>" onchange="markDirty(<%= ex.id %>)">
                </div>
                <div class="input-group">
                    <label>Reps Feitas</label>
                    <input type="text" name="logs[<%= ex.id %>][reps]" placeholder="<%= ex.reps %>" onchange="markDirty(<%= ex.id %>)">
                </div>
            </div>
            
            <% if (ex.video_url) { %>
                <div style="margin-top: 15px; text-align: center;">
                    <a href="<%= ex.video_url %>" target="_blank" class="btn btn-sm btn-outline" style="font-size: 0.8rem;">
                        <i class="fas fa-video"></i> Ver Execução
                    </a>
                </div>
            <% } %>
        </div>
        <% }) %>
    </form>

    <div style="position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 20px; z-index: 100;">
        <button type="button" class="btn btn-primary btn-full btn-lg" onclick="openFinishModal()" style="box-shadow: 0 5px 20px rgba(190, 242, 2, 0.3);">
            Concluir Treino <i class="fas fa-flag-checkered" style="margin-left: 10px;"></i>
        </button>
    </div>

</div>

<div class="modal-overlay" id="finishModal">
    <div class="modal-box">
        <h3 class="text-neon">Treino Concluído!</h3>
        <p class="text-muted">Como foi o esforço hoje?</p>
        
        <div class="rating-stars" id="starRating">
            <i class="fas fa-fire" data-val="1"></i>
            <i class="fas fa-fire" data-val="2"></i>
            <i class="fas fa-fire" data-val="3"></i>
            <i class="fas fa-fire" data-val="4"></i>
            <i class="fas fa-fire" data-val="5"></i>
        </div>
        <input type="hidden" id="effortLevel" value="3">

        <textarea id="feedbackText" class="form-input" rows="3" placeholder="Alguma observação para o personal? (Ex: Senti dor no ombro...)" style="margin-bottom: 20px; font-size: 0.9rem;"></textarea>

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline btn-full" onclick="closeFinishModal()">Cancelar</button>
            <button class="btn btn-primary btn-full" onclick="submitWorkout()">Salvar</button>
        </div>
    </div>
</div>

<script>
    function toggleComplete(id) {
        const card = document.getElementById('card-' + id);
        const btn = card.querySelector('.check-btn');
        card.classList.toggle('completed');
        btn.classList.toggle('active');
    }

    function markDirty(id) {
        const card = document.getElementById('card-' + id);
        if (!card.classList.contains('completed')) {
            toggleComplete(id);
        }
    }

    // Modal Logic
    const modal = document.getElementById('finishModal');
    function openFinishModal() { modal.style.display = 'flex'; }
    function closeFinishModal() { modal.style.display = 'none'; }

    // Rating Logic
    const stars = document.querySelectorAll('.rating-stars i');
    const effortInput = document.getElementById('effortLevel');
    stars.forEach(star => {
        star.addEventListener('click', () => {
            const val = star.getAttribute('data-val');
            effortInput.value = val;
            stars.forEach(s => {
                s.classList.remove('active');
                if (s.getAttribute('data-val') <= val) s.classList.add('active');
            });
        });
    });

    // Submit Logic
    async function submitWorkout() {
        const btn = document.querySelector('#finishModal .btn-primary');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        
        const form = document.getElementById('workoutForm');
        const formData = new FormData(form);
        const data = { logs: {}, feedback_text: document.getElementById('feedbackText').value, effort_level: effortInput.value };
        
        // Manual form parsing to structure JSON
        const inputs = form.querySelectorAll('input');
        inputs.forEach(input => {
            if(input.name.includes('logs')) {
                // name="logs[12][weight]"
                const matches = input.name.match(/logs\[(\d+)\]\[(\w+)\]/);
                if (matches) {
                    const id = matches[1];
                    const field = matches[2];
                    if (!data.logs[id]) data.logs[id] = {};
                    data.logs[id][field] = input.value;
                }
            }
        });

        try {
            const res = await fetch(window.location.pathname + '/complete', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>' 
                },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            
            if (json.success) {
                window.location.href = json.redirect;
            } else {
                alert('Erro: ' + json.error);
                btn.innerHTML = 'Salvar';
            }
        } catch (e) {
            alert('Erro de conexão.');
            btn.innerHTML = 'Salvar';
        }
    }
</script>

<%- include('../partials/footer.ejs') %>
