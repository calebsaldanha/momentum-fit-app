<%- include('../partials/header.ejs') %>
<div class="dashboard-container">
    <%- include('../partials/sidebar.ejs', { path: '/client/financial' }) %>
    <main class="dashboard-main">
        <div class="mobile-dash-header">
            <button id="sidebarOpenBtn" class="btn btn-outline btn-sm"><i class="fas fa-bars"></i></button>
            <span>Financeiro</span>
        </div>

        <div class="page-header">
            <h1>Meu <span class="text-neon">Plano</span></h1>
            <p>Detalhes da sua assinatura e histórico.</p>
        </div>

        <div style="display: grid; gap: 30px; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
            
            <div class="card-box" style="border: 1px solid var(--primary-color);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:white; margin:0;">Assinatura Ativa</h3>
                    <span style="background:rgba(190,242,2,0.2); color:var(--primary-color); padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold;">ATIVO</span>
                </div>
                
                <% if (subscription) { %>
                    <h2 style="font-size:2.5rem; color:white; margin-bottom:10px;"><%= subscription.plan_name %></h2>
                    <p style="color:#aaa; margin-bottom:20px;"><%= subscription.features %></p>
                    <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="color:#888;">Valor</span>
                            <span style="color:white; font-weight:bold;">R$ <%= parseFloat(subscription.price).toFixed(2) %>/mês</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:#888;">Renovação</span>
                            <span style="color:white;">
                                <%= subscription.next_billing_date ? new Date(subscription.next_billing_date).toLocaleDateString() : 'Automática' %>
                            </span>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="width:100%;">Gerenciar Assinatura</button>
                <% } else { %>
                    <p style="color:#ccc;">Você ainda não possui um plano ativo.</p>
                    <a href="/plans" class="btn btn-primary" style="width:100%; margin-top:20px;">Escolher Plano</a>
                <% } %>
            </div>

            <div class="card-box" style="grid-column: 1 / -1;">
                <h3 style="color:white; margin-bottom:20px;">Histórico de Pagamentos</h3>
                <% if (payments && payments.length > 0) { %>
                    <div class="table-responsive">
                        <table style="width:100%; text-align:left; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom:1px solid #333;">
                                    <th style="padding:15px; color:#888;">Data</th>
                                    <th style="padding:15px; color:#888;">Descrição</th>
                                    <th style="padding:15px; color:#888;">Valor</th>
                                    <th style="padding:15px; color:#888;">Status</th>
                                    <th style="padding:15px; color:#888;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <% payments.forEach(pay => { %>
                                    <tr style="border-bottom:1px solid #222;">
                                        <td style="padding:15px; color:white;"><%= new Date(pay.created_at).toLocaleDateString() %></td>
                                        <td style="padding:15px; color:white;"><%= pay.plan_name || 'Serviço' %></td>
                                        <td style="padding:15px; color:white;">R$ <%= parseFloat(pay.amount).toFixed(2) %></td>
                                        <td style="padding:15px;">
                                            <% if(pay.status === 'paid') { %>
                                                <span style="color:#bef202;">Pago</span>
                                            <% } else if(pay.status === 'pending') { %>
                                                <span style="color:orange;">Pendente</span>
                                            <% } else { %>
                                                <span style="color:red;">Falha</span>
                                            <% } %>
                                        </td>
                                        <td style="padding:15px; text-align:right;">
                                            <button class="btn btn-outline btn-sm"><i class="fas fa-file-invoice"></i></button>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <p style="color:#666; font-style:italic;">Nenhum pagamento registrado.</p>
                <% } %>
            </div>
        </div>
    </main>
</div>
<%- include('../partials/footer.ejs') %>
