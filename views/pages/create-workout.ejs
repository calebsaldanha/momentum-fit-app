<%- include('../partials/header.ejs') %>

<div class="dashboard-container">
    <%- include('../partials/sidebar.ejs', { active: 'workouts' }) %>

    <main class="dashboard-main">
        <div class="page-header" style="text-align: left; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Novo Treino</h1>
                <p class="text-muted">Monte um treino personalizado ou use um template.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-outline" onclick="openTemplateModal()">
                    <i class="fas fa-folder-open"></i> Carregar Template
                </button>
            </div>
        </div>

        <div class="card-box">
            <form id="createWorkoutForm">
                <div class="form-group">
                    <label>Aluno</label>
                    <select name="client_id" class="form-input" required <%= selectedClientId ? 'disabled' : '' %>>
                        <option value="">Selecione um aluno...</option>
                        <% clients.forEach(client => { %>
                            <option value="<%= client.id %>" <%= selectedClientId == client.id ? 'selected' : '' %>><%= client.name %></option>
                        <% }) %>
                    </select>
                    <% if(selectedClientId) { %> <input type="hidden" name="client_id" value="<%= selectedClientId %>"> <% } %>
                </div>

                <div class="form-group">
                    <label>Título do Treino</label>
                    <input type="text" name="title" class="form-input" placeholder="Ex: Treino A - Peito e Tríceps" required>
                </div>

                <div class="form-group">
                    <label>Dia Sugerido</label>
                    <select name="day_of_week" class="form-input">
                        <option value="Segunda">Segunda-feira</option>
                        <option value="Terça">Terça-feira</option>
                        <option value="Quarta">Quarta-feira</option>
                        <option value="Quinta">Quinta-feira</option>
                        <option value="Sexta">Sexta-feira</option>
                        <option value="Sábado">Sábado</option>
                        <option value="Domingo">Domingo</option>
                        <option value="Flexível">Flexível</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Descrição / Foco</label>
                    <textarea name="description" class="form-input" rows="2" placeholder="Instruções gerais..."></textarea>
                </div>

                <div style="margin: 30px 0;">
                    <h3 style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">Exercícios</h3>
                    <div id="exerciseList">
                        </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="button" class="btn btn-sm btn-outline" onclick="addExerciseRow()">
                            <i class="fas fa-plus"></i> Adicionar Manual
                        </button>
                        <button type="button" class="btn btn-sm btn-outline" onclick="openLibraryModal()">
                            <i class="fas fa-book"></i> Da Biblioteca
                        </button>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 40px; border-top: 1px solid #333; padding-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="saveAsTemplate()">
                        <i class="fas fa-save"></i> Salvar como Template
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        Criar e Enviar <i class="fas fa-paper-plane" style="margin-left: 8px;"></i>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<div class="modal-overlay" id="templateModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div class="modal-box" style="background: #111; padding: 25px; border-radius: 12px; border: 1px solid #333; width: 90%; max-width: 500px;">
        <h3 class="text-neon" style="margin-bottom: 15px;">Meus Templates</h3>
        <div id="templateList" style="max-height: 300px; overflow-y: auto; text-align: left;">
            <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando...</p>
        </div>
        <button class="btn btn-sm btn-outline" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('templateModal').style.display='none'">Fechar</button>
    </div>
</div>

<script>
    let exerciseCount = 0;

    function addExerciseRow(data = {}) {
        exerciseCount++;
        const div = document.createElement('div');
        div.className = 'exercise-row';
        div.style.cssText = 'background: #0a0a0a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #222; display: grid; grid-template-columns: 2fr 1fr 1fr 2fr 30px; gap: 10px; align-items: center;';
        
        div.innerHTML = `
            <input type="text" name="exercises[${exerciseCount}][name]" placeholder="Nome do Exercício" class="form-input" value="${data.name || ''}" required>
            <input type="text" name="exercises[${exerciseCount}][sets]" placeholder="Séries" class="form-input" value="${data.sets || ''}">
            <input type="text" name="exercises[${exerciseCount}][reps]" placeholder="Reps" class="form-input" value="${data.reps || ''}">
            <input type="text" name="exercises[${exerciseCount}][notes]" placeholder="Notas (ex: Drop-set)" class="form-input" value="${data.notes || ''}">
            <input type="hidden" name="exercises[${exerciseCount}][id]" value="${data.id || ''}">
            <input type="hidden" name="exercises[${exerciseCount}][order_index]" value="${exerciseCount}">
            <button type="button" class="btn btn-sm btn-ghost" onclick="this.parentElement.remove()" style="color: #ff4d4d;"><i class="fas fa-trash"></i></button>
        `;
        document.getElementById('exerciseList').appendChild(div);
    }

    // Lógica de Templates
    function openTemplateModal() {
        document.getElementById('templateModal').style.display = 'flex';
        fetch('/workouts/api/templates')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('templateList');
                list.innerHTML = '';
                if(data.length === 0) {
                    list.innerHTML = '<p class="text-muted">Nenhum template salvo.</p>';
                    return;
                }
                data.forEach(t => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 10px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                    item.innerHTML = `<span>${t.title}</span> <button class="btn btn-sm btn-primary">Usar</button>`;
                    item.onclick = () => loadTemplate(t.id);
                    list.appendChild(item);
                });
            });
    }

    function loadTemplate(id) {
        fetch('/workouts/api/templates/' + id)
            .then(res => res.json())
            .then(data => {
                document.querySelector('input[name="title"]').value = data.template.title;
                document.querySelector('textarea[name="description"]').value = data.template.description || '';
                document.getElementById('exerciseList').innerHTML = ''; // Limpa atual
                exerciseCount = 0;
                data.exercises.forEach(ex => addExerciseRow(ex));
                document.getElementById('templateModal').style.display = 'none';
            });
    }

    function saveAsTemplate() {
        const title = document.querySelector('input[name="title"]').value;
        if(!title) return alert('Dê um título ao treino antes de salvar como template.');
        
        // Coletar dados manualmente para evitar submit do form
        const exercises = [];
        document.querySelectorAll('.exercise-row').forEach(row => {
            exercises.push({
                name: row.querySelector('input[name*="[name]"]').value,
                sets: row.querySelector('input[name*="[sets]"]').value,
                reps: row.querySelector('input[name*="[reps]"]').value,
                notes: row.querySelector('input[name*="[notes]"]').value,
                order_index: row.querySelector('input[name*="[order_index]"]').value
            });
        });

        fetch('/workouts/templates/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
            body: JSON.stringify({ title, description: document.querySelector('textarea[name="description"]').value, exercises })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) alert('Template salvo com sucesso!');
            else alert('Erro ao salvar.');
        });
    }

    // Submit Principal
    document.getElementById('createWorkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerHTML = 'Enviando...';
        
        // Serialização customizada similar ao saveAsTemplate
        const exercises = [];
        document.querySelectorAll('.exercise-row').forEach(row => {
            exercises.push({
                id: row.querySelector('input[name*="[id]"]').value,
                name: row.querySelector('input[name*="[name]"]').value,
                sets: row.querySelector('input[name*="[sets]"]').value,
                reps: row.querySelector('input[name*="[reps]"]').value,
                notes: row.querySelector('input[name*="[notes]"]').value,
                order_index: row.querySelector('input[name*="[order_index]"]').value,
                video_url: '', image_url: '' 
            });
        });

        const formData = {
            client_id: document.querySelector('select[name="client_id"]').value || document.querySelector('input[name="client_id"]')?.value,
            title: document.querySelector('input[name="title"]').value,
            day_of_week: document.querySelector('select[name="day_of_week"]').value,
            description: document.querySelector('textarea[name="description"]').value,
            exercises: exercises
        };

        try {
            const res = await fetch('/workouts/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
                body: JSON.stringify(formData)
            });
            const json = await res.json();
            if(json.success) {
                window.location.href = '/trainer/dashboard?success=workout_created';
            } else {
                alert(json.message);
                btn.innerHTML = 'Tentar Novamente';
            }
        } catch(e) { console.error(e); alert('Erro de conexão'); }
    });
</script>

<%- include('../partials/footer.ejs') %>
