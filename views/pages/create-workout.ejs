<%- include('../partials/header.ejs', { title: 'Novo Treino', bodyClass: 'dashboard-body' }) %>

<div class="dashboard-container">
    <%- include('../partials/admin-sidebar.ejs', { currentPage: 'workouts' }) %>
    
    <main class="dashboard-main">
        <div class="section">
            <div class="section-header">
                <h1>Novo Treino</h1>
                <a href="/admin/clients<%= typeof selectedClientId !== 'undefined' && selectedClientId ? '/' + selectedClientId : '' %>" class="btn btn-outline btn-sm">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <form id="createWorkoutForm" class="dashboard-form" style="max-width: 100%;">
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="client_id">Aluno</label>
                        <select name="client_id" id="client_id" required style="width: 100%; padding: 10px; border-radius: 6px; background: #222; color: #fff; border: 1px solid #444;">
                            <option value="" disabled <%= !selectedClientId ? 'selected' : '' %>>Selecione o aluno...</option>
                            <% if (typeof clients !== 'undefined' && clients.length > 0) { %>
                                <% clients.forEach(client => { %>
                                    <option value="<%= client.id %>" <%= typeof selectedClientId !== 'undefined' && selectedClientId == client.id ? 'selected' : '' %>>
                                        <%= client.name %>
                                    </option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="title">Título do Treino</label>
                        <input type="text" id="title" name="title" placeholder="Ex: Treino A - Superiores" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descrição / Foco</label>
                    <textarea id="description" name="description" rows="2" placeholder="Objetivo deste treino..."></textarea>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid var(--c-border); padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--c-accent-primary);">Exercícios</h3>
                        <button type="button" id="addExerciseBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    
                    <div id="exercisesList">
                        </div>
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-save"></i> Salvar Treino
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<template id="exerciseTemplate">
    <div class="exercise-card" style="background: var(--c-bg-card); border: 1px solid var(--c-border); padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span class="exercise-number" style="background: var(--c-accent-primary); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold;">#1</span>
            <button type="button" class="remove-exercise" style="background: none; border: none; color: var(--c-error); cursor: pointer;">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
        
        <div class="form-group">
            <label>Nome do Exercício</label>
            <input type="text" class="ex-name" required placeholder="Ex: Supino Reto">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Séries</label>
                <input type="text" class="ex-sets" required placeholder="Ex: 4">
            </div>
            <div class="form-group">
                <label>Repetições</label>
                <input type="text" class="ex-reps" required placeholder="Ex: 10-12">
            </div>
            <div class="form-group">
                <label>Descanso (s)</label>
                <input type="text" class="ex-rest" placeholder="Ex: 60">
            </div>
        </div>

        <div class="form-group" style="margin-top: 10px;">
            <label>Observações / Técnica</label>
            <input type="text" class="ex-notes" placeholder="Detalhes de execução...">
        </div>
        <div class="form-group">
            <label>Link de Vídeo (Opcional)</label>
            <input type="url" class="ex-video" placeholder="https://youtube.com/...">
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const exercisesList = document.getElementById('exercisesList');
    const addBtn = document.getElementById('addExerciseBtn');
    const form = document.getElementById('createWorkoutForm');
    const template = document.getElementById('exerciseTemplate');

    // Função para adicionar exercício
    addBtn.addEventListener('click', () => {
        const clone = template.content.cloneNode(true);
        const index = exercisesList.children.length + 1;
        
        clone.querySelector('.exercise-number').textContent = '#' + index;
        
        // Botão remover
        clone.querySelector('.remove-exercise').addEventListener('click', (e) => {
            e.target.closest('.exercise-card').remove();
            updateNumbers();
        });

        exercisesList.appendChild(clone);
    });

    // Atualiza numeração ao remover
    function updateNumbers() {
        Array.from(exercisesList.children).forEach((card, idx) => {
            card.querySelector('.exercise-number').textContent = '#' + (idx + 1);
        });
    }

    // Adiciona um exercício inicial por padrão
    addBtn.click();

    // Envio do formulário
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        try {
            // Coletar dados dos exercícios
            const exerciseCards = document.querySelectorAll('.exercise-card');
            const exercises = Array.from(exerciseCards).map((card, index) => ({
                name: card.querySelector('.ex-name').value,
                sets: card.querySelector('.ex-sets').value,
                reps: card.querySelector('.ex-reps').value,
                notes: card.querySelector('.ex-notes').value + (card.querySelector('.ex-rest').value ? ` | Descanso: ${card.querySelector('.ex-rest').value}s` : ''),
                video_url: card.querySelector('.ex-video').value,
                order_index: index
            }));

            if (exercises.length === 0) {
                alert('Adicione pelo menos um exercício.');
                throw new Error('Sem exercícios');
            }
            
            const clientId = document.getElementById('client_id').value;
            if(!clientId) {
                alert('Selecione um aluno.');
                throw new Error('Sem aluno');
            }

            const payload = {
                client_id: clientId,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                exercises: exercises
            };

            const response = await fetch('/workouts/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>' // Token CSRF injetado
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                window.location.href = `/admin/clients/${result.clientId}`;
            } else {
                alert('Erro ao salvar: ' + (result.message || 'Erro desconhecido'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error(error);
            if(error.message !== 'Sem exercícios' && error.message !== 'Sem aluno') {
                alert('Erro de conexão ao salvar treino.');
            }
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
});
</script>

<%- include('../partials/footer.ejs') %>
