<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('../partials/header', { title: 'Novo Treino' }) %>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        /* Estilos específicos para o Modal da Biblioteca */
        #libraryModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            z-index: 9999; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1a1a1a; width: 90%; max-width: 1000px; height: 90vh;
            border-radius: 16px; border: 1px solid #333; display: flex; flex-direction: column;
        }
        .lib-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; padding: 1.5rem; overflow-y: auto;
        }
        .lib-card {
            background: #252525; border: 2px solid transparent; border-radius: 12px; cursor: pointer; overflow: hidden; transition: all 0.2s;
        }
        .lib-card:hover { border-color: #666; transform: translateY(-3px); }
        .lib-card.selected { border-color: var(--primary-color); background: rgba(var(--primary-rgb), 0.1); }
        .lib-img { width: 100%; height: 100px; object-fit: cover; background: #000; }
        
        /* Card de Exercício Selecionado */
        .exercise-item {
            background: #252525; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.05); display: flex; gap: 1rem; align-items: flex-start;
        }
        .exercise-inputs {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;
        }
        @media(max-width: 768px) { .exercise-item { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <%- include('../partials/sidebar', { currentPage: 'create-workout' }) %>
        
        <main class="dashboard-main">
            <header class="d-flex justify-content-between align-items-center mb-4">
                <h1>Novo Treino</h1>
                <a href="/admin/clients" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
            </header>

            <form id="createWorkoutForm">
                <div class="dashboard-card">
                    <div class="row" style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Aluno</label>
                            <select name="client_id" id="client_id" class="form-input" required>
                                <option value="" disabled <%= !selectedClientId ? 'selected' : '' %>>Selecione...</option>
                                <% if (clients && clients.length > 0) { %>
                                    <% clients.forEach(c => { %>
                                        <option value="<%= c.id %>" <%= selectedClientId == c.id ? 'selected' : '' %>><%= c.name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Título do Treino</label>
                            <input type="text" id="title" class="form-input" placeholder="Ex: Treino A - Hipertrofia" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descrição / Foco</label>
                        <textarea id="description" class="form-input" rows="2"></textarea>
                    </div>

                    <hr class="my-4" style="border-color: var(--border-color);">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="m-0 text-primary">Exercícios</h3>
                        <div class="d-flex gap-2">
                            <button type="button" onclick="openLibraryModal()" class="btn btn-primary">
                                <i class="fas fa-list"></i> Biblioteca
                            </button>
                            <button type="button" id="addManualBtn" class="btn btn-secondary">
                                <i class="fas fa-plus"></i> Manual
                            </button>
                        </div>
                    </div>

                    <div id="exercisesList">
                        <p class="text-muted text-center py-4" id="emptyMsg">Nenhum exercício adicionado.</p>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary w-100 py-3" style="font-size: 1.1rem;">
                            <i class="fas fa-save"></i> Salvar Treino
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <div id="libraryModal">
        <div class="modal-content">
            <div style="padding: 1.5rem; border-bottom: 1px solid #333; display: flex; justify-content: space-between;">
                <h2 class="m-0">Selecionar Exercícios</h2>
                <button onclick="closeLibraryModal()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i></button>
            </div>
            <div style="padding: 1rem;">
                <input type="text" id="searchLib" class="form-input" placeholder="Buscar exercício...">
            </div>
            <div id="libraryGrid" class="lib-grid"></div>
            <div style="padding: 1.5rem; border-top: 1px solid #333; text-align: right;">
                <button onclick="addSelectedExercises()" class="btn btn-primary">Concluir Seleção</button>
            </div>
        </div>
    </div>

    <script>
        const libraryData = <%- JSON.stringify(exerciseLibrary || []) %>;
        let selectedExercises = new Set();
        const listContainer = document.getElementById('exercisesList');

        function openLibraryModal() {
            document.getElementById('libraryModal').style.display = 'flex';
            renderLibrary(libraryData);
        }
        function closeLibraryModal() {
            document.getElementById('libraryModal').style.display = 'none';
        }

        function renderLibrary(items) {
            const grid = document.getElementById('libraryGrid');
            grid.innerHTML = items.map(ex => `
                <div class="lib-card ${selectedExercises.has(String(ex.id)) ? 'selected' : ''}" onclick="toggleSelect('${ex.id}', this)">
                    <img src="${ex.image_url || '/images/momentum-fit-icon.png'}" class="lib-img">
                    <div style="padding: 0.8rem;">
                        <div style="font-weight:bold; font-size:0.9rem;">${ex.name}</div>
                        <small class="text-muted">${ex.category || ''}</small>
                    </div>
                </div>
            `).join('');
        }

        function toggleSelect(id, el) {
            if(selectedExercises.has(id)) {
                selectedExercises.delete(id);
                el.classList.remove('selected');
            } else {
                selectedExercises.add(id);
                el.classList.add('selected');
            }
        }

        function addSelectedExercises() {
            selectedExercises.forEach(id => {
                const ex = libraryData.find(e => String(e.id) === id);
                if(ex) addExerciseToForm(ex);
            });
            selectedExercises.clear();
            closeLibraryModal();
        }

        document.getElementById('addManualBtn').addEventListener('click', () => addExerciseToForm({name: ''}));

        function addExerciseToForm(data) {
            document.getElementById('emptyMsg').style.display = 'none';
            const idx = listContainer.children.length;
            const div = document.createElement('div');
            div.className = 'exercise-item';
            div.innerHTML = `
                <div style="width: 80px; height: 80px; background: #000; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                    ${data.image_url ? `<img src="${data.image_url}" style="width:100%; height:100%; object-fit:cover;">` : '<div style="height:100%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-dumbbell text-muted"></i></div>'}
                </div>
                <div style="flex: 1;">
                    <div class="d-flex justify-content-between mb-2">
                        <input type="text" class="form-input ex-name" value="${data.name}" placeholder="Nome do Exercício" style="font-weight:bold; border:none; background:transparent; padding:0;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.exercise-item').remove()"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="exercise-inputs">
                        <input type="text" class="form-input ex-sets" placeholder="Séries (ex: 3)">
                        <input type="text" class="form-input ex-reps" placeholder="Reps (ex: 12)">
                        <input type="text" class="form-input ex-weight" placeholder="Carga (kg)">
                    </div>
                    <input type="text" class="form-input ex-notes mt-2" style="font-size: 0.85rem;" placeholder="Observações..." value="${data.description || ''}">
                    
                    <input type="hidden" class="ex-id" value="${data.id || ''}">
                    <input type="hidden" class="ex-image" value="${data.image_url || ''}">
                    <input type="hidden" class="ex-video" value="${data.video_url || ''}">
                </div>
            `;
            listContainer.appendChild(div);
        }

        document.getElementById('searchLib').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderLibrary(libraryData.filter(x => x.name.toLowerCase().includes(term)));
        });

        // Envio do Formulário
        document.getElementById('createWorkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const exercises = Array.from(document.querySelectorAll('.exercise-item')).map((item, index) => ({
                id: item.querySelector('.ex-id').value || null,
                name: item.querySelector('.ex-name').value,
                sets: item.querySelector('.ex-sets').value,
                reps: item.querySelector('.ex-reps').value,
                weight: item.querySelector('.ex-weight').value,
                notes: item.querySelector('.ex-notes').value,
                video_url: item.querySelector('.ex-video').value,
                image_url: item.querySelector('.ex-image').value,
                order_index: index
            }));

            if(exercises.length === 0) return alert("Adicione pelo menos um exercício.");

            try {
                const res = await fetch('/workouts/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
                    body: JSON.stringify({
                        client_id: document.getElementById('client_id').value,
                        title: document.getElementById('title').value,
                        description: document.getElementById('description').value,
                        exercises
                    })
                });
                const json = await res.json();
                if(json.success) window.location.href = `/admin/clients/${document.getElementById('client_id').value}`;
                else alert("Erro: " + json.message);
            } catch(err) {
                alert("Erro ao salvar.");
            }
        });
    </script>
</body>
</html>
