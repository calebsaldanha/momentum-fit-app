<%- include('../partials/header.ejs', { title: 'Novo Treino', bodyClass: 'dashboard-body' }) %>

<div class="dashboard-container">
    <%- include('../partials/admin-sidebar.ejs', { currentPage: 'workouts' }) %>
    
    <main class="dashboard-main">
        <div class="section">
            <div class="section-header">
                <h1>Novo Treino</h1>
                <a href="/admin/clients<%= typeof selectedClientId !== 'undefined' && selectedClientId ? '/' + selectedClientId : '' %>" class="btn btn-outline btn-sm">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <form id="createWorkoutForm" class="dashboard-form" style="max-width: 100%;">
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="client_id">Aluno</label>
                        <select name="client_id" id="client_id" required style="width: 100%; padding: 10px; border-radius: 6px; background: #222; color: #fff; border: 1px solid #444;">
                            <option value="" disabled <%= !selectedClientId ? 'selected' : '' %>>Selecione o aluno...</option>
                            <% if (typeof clients !== 'undefined' && clients.length > 0) { %>
                                <% clients.forEach(client => { %>
                                    <option value="<%= client.id %>" <%= typeof selectedClientId !== 'undefined' && selectedClientId == client.id ? 'selected' : '' %>>
                                        <%= client.name %>
                                    </option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="title">Título do Treino</label>
                        <input type="text" id="title" name="title" placeholder="Ex: Treino A - Superiores" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descrição / Foco</label>
                    <textarea id="description" name="description" rows="2" placeholder="Objetivo deste treino..."></textarea>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid var(--c-border); padding-top: 20px;">
                    
                    <button type="button" onclick="openLibraryModal()" class="btn btn-outline" style="width: 100%; padding: 20px; border-style: dashed; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; margin-bottom: 20px;">
                        <i class="fas fa-images"></i> <strong>Abrir Biblioteca de Exercícios</strong>
                    </button>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--c-accent-primary);">Exercícios Selecionados</h3>
                        <button type="button" id="addExerciseBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i> Adicionar Manual
                        </button>
                    </div>
                    
                    <div id="exercisesList"></div>
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-save"></i> Salvar Treino
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<div id="libraryModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: 0 auto; background: #111; border-radius: 12px; display: flex; flex-direction: column; height: 90vh; border: 1px solid #333;">
        
        <div style="padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; border-radius: 12px 12px 0 0;">
            <div>
                <h2 style="margin: 0;">Biblioteca de Exercícios</h2>
                <p style="margin: 5px 0 0; color: #888; font-size: 0.9rem;">Selecione os exercícios para adicionar ao treino.</p>
            </div>
            <button onclick="closeLibraryModal()" style="background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px; background: #111;">
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                <input type="text" id="searchLibrary" placeholder="Buscar por nome, categoria ou descrição..." style="width: 100%; padding: 15px 15px 15px 45px; background: #000; border: 1px solid #444; color: white; border-radius: 8px; font-size: 1rem;">
            </div>
        </div>
        
        <div id="libraryGrid" style="flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; align-content: start;">
            </div>

        <div style="padding: 20px; border-top: 1px solid #333; background: #1a1a1a; border-radius: 0 0 12px 12px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #ccc;">
                <span id="selectedCount" style="color: var(--c-accent-primary); font-weight: bold; font-size: 1.2rem;">0</span> selecionados
            </div>
            <button onclick="addSelectedExercises()" class="btn btn-primary" style="padding: 10px 30px;">
                Adicionar ao Treino <i class="fas fa-check" style="margin-left: 5px;"></i>
            </button>
        </div>
    </div>
</div>

<template id="exerciseTemplate">
    <div class="exercise-card" style="background: var(--c-bg-card); border: 1px solid var(--c-border); padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative; display: grid; grid-template-columns: 100px 1fr; gap: 20px; transition: all 0.3s ease;">
        <div class="ex-image-preview" style="width: 100px; height: 100px; background: #000; border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #333;">
            <i class="fas fa-dumbbell" style="color: #444; font-size: 1.5rem;"></i>
        </div>
        <input type="hidden" class="ex-image-url">

        <div style="width: 100%;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="exercise-number" style="background: var(--c-accent-primary); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold;">#1</span>
                    <span class="drag-handle" style="color: #666; cursor: grab;"><i class="fas fa-grip-lines"></i></span>
                </div>
                <button type="button" class="remove-exercise" style="background: none; border: none; color: var(--c-error); cursor: pointer; padding: 5px;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="form-group">
                <input type="text" class="ex-name" required placeholder="Nome do Exercício" style="font-weight: bold; font-size: 1.1rem; border: none; border-bottom: 1px solid #444; padding-left: 0; border-radius: 0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;">
                <div class="form-group">
                    <label style="font-size: 0.8rem; color: #888;">Séries</label>
                    <input type="text" class="ex-sets" required placeholder="Ex: 4">
                </div>
                <div class="form-group">
                    <label style="font-size: 0.8rem; color: #888;">Repetições</label>
                    <input type="text" class="ex-reps" required placeholder="Ex: 12">
                </div>
                <div class="form-group">
                    <label style="font-size: 0.8rem; color: #888;">Descanso (s)</label>
                    <input type="text" class="ex-rest" placeholder="60">
                </div>
            </div>
            
            <div style="margin-top: 10px;">
                <input type="text" class="ex-notes" placeholder="Observações técnicas..." style="font-size: 0.9rem;">
            </div>
            <input type="url" class="ex-video" placeholder="Link Vídeo (YouTube)" style="margin-top: 10px; font-size: 0.85rem;">
        </div>
    </div>
</template>

<style>
    /* Estilos do Modal e Grid */
    .lib-item {
        background: #222;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        position: relative;
    }
    .lib-item:hover {
        transform: translateY(-2px);
        background: #2a2a2a;
    }
    .lib-item.selected {
        border-color: var(--c-accent-primary);
        background: rgba(37, 99, 235, 0.1);
    }
    .lib-item.selected::after {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--c-accent-primary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .lib-img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        background: #000;
    }
    .lib-info {
        padding: 12px;
    }
    .lib-name {
        font-weight: 600;
        margin-bottom: 4px;
        color: #fff;
    }
    .lib-desc {
        font-size: 0.8rem;
        color: #888;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .lib-category {
        display: inline-block;
        font-size: 0.7rem;
        background: #333;
        color: #ccc;
        padding: 2px 6px;
        border-radius: 4px;
        margin-bottom: 6px;
    }
</style>

<script>
    // Dados da Biblioteca (Injetados pelo Back-end)
    const libraryData = <%- JSON.stringify(typeof exerciseLibrary !== 'undefined' ? exerciseLibrary : []) %>;
    
    // Elementos DOM
    const exercisesList = document.getElementById('exercisesList');
    const template = document.getElementById('exerciseTemplate');
    const libraryModal = document.getElementById('libraryModal');
    const libraryGrid = document.getElementById('libraryGrid');
    const searchInput = document.getElementById('searchLibrary');
    const selectedCountSpan = document.getElementById('selectedCount');

    // Estado da Seleção
    let selectedExercises = new Set(); // Armazena IDs selecionados

    // --- Funções Principais ---

    // Adiciona um card de exercício ao formulário principal
    function addExerciseCard(data = null) {
        const clone = template.content.cloneNode(true);
        const index = exercisesList.children.length + 1;
        
        clone.querySelector('.exercise-number').textContent = '#' + index;
        
        if(data) {
            clone.querySelector('.ex-name').value = data.name || '';
            clone.querySelector('.ex-video').value = data.video_url || '';
            clone.querySelector('.ex-notes').value = data.description || ''; // Usa a descrição como obs inicial
            
            if(data.image_url) {
                clone.querySelector('.ex-image-url').value = data.image_url;
                clone.querySelector('.ex-image-preview').innerHTML = `<img src="${data.image_url}" style="width:100%; height:100%; object-fit:cover;">`;
            }
        }

        clone.querySelector('.remove-exercise').addEventListener('click', (e) => {
            e.target.closest('.exercise-card').remove();
            updateNumbers();
        });

        exercisesList.appendChild(clone);
    }

    function updateNumbers() {
        Array.from(exercisesList.children).forEach((card, idx) => {
            card.querySelector('.exercise-number').textContent = '#' + (idx + 1);
        });
    }

    document.getElementById('addExerciseBtn').addEventListener('click', () => addExerciseCard());

    // --- Lógica do Modal da Biblioteca ---

    window.openLibraryModal = function() {
        selectedExercises.clear(); // Limpa seleção anterior ao abrir
        updateSelectedCount();
        renderLibrary(libraryData);
        libraryModal.style.display = 'block';
        searchInput.focus();
    }

    window.closeLibraryModal = function() {
        libraryModal.style.display = 'none';
    }

    // Renderiza a Grid
    function renderLibrary(items) {
        libraryGrid.innerHTML = '';
        
        if(items.length === 0) {
            libraryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Nenhum exercício encontrado.</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = `lib-item ${selectedExercises.has(item.id) ? 'selected' : ''}`;
            div.onclick = () => toggleSelection(div, item.id);

            const imgHtml = item.image_url 
                ? `<img src="${item.image_url}" class="lib-img">`
                : `<div class="lib-img" style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-dumbbell" style="font-size: 2rem; color: #444;"></i></div>`;

            div.innerHTML = `
                ${imgHtml}
                <div class="lib-info">
                    ${item.category ? `<span class="lib-category">${item.category}</span>` : ''}
                    <div class="lib-name">${item.name}</div>
                    <div class="lib-desc">${item.description || 'Sem descrição.'}</div>
                </div>
            `;
            libraryGrid.appendChild(div);
        });
    }

    // Toggle de Seleção (Múltipla)
    function toggleSelection(el, id) {
        if (selectedExercises.has(id)) {
            selectedExercises.delete(id);
            el.classList.remove('selected');
        } else {
            selectedExercises.add(id);
            el.classList.add('selected');
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedCountSpan.textContent = selectedExercises.size;
    }

    // Busca em tempo real
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = libraryData.filter(x => 
            x.name.toLowerCase().includes(term) || 
            (x.category && x.category.toLowerCase().includes(term)) ||
            (x.description && x.description.toLowerCase().includes(term))
        );
        renderLibrary(filtered);
    });

    // Botão "Adicionar Selecionados"
    window.addSelectedExercises = function() {
        const selectedIds = Array.from(selectedExercises);
        if(selectedIds.length === 0) {
            alert("Selecione pelo menos um exercício.");
            return;
        }

        // Adiciona cada selecionado à lista principal
        selectedIds.forEach(id => {
            const exerciseData = libraryData.find(x => x.id === id);
            if(exerciseData) {
                addExerciseCard(exerciseData);
            }
        });

        closeLibraryModal();
        
        // Scroll suave até o final da lista
        setTimeout(() => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
    }

    // --- Envio do Formulário ---
    document.getElementById('createWorkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        try {
            const exercises = Array.from(document.querySelectorAll('.exercise-card')).map((card, index) => ({
                name: card.querySelector('.ex-name').value,
                sets: card.querySelector('.ex-sets').value,
                reps: card.querySelector('.ex-reps').value,
                notes: card.querySelector('.ex-notes').value + (card.querySelector('.ex-rest').value ? ` | Descanso: ${card.querySelector('.ex-rest').value}s` : ''),
                video_url: card.querySelector('.ex-video').value,
                image_url: card.querySelector('.ex-image-url').value,
                order_index: index
            }));

            if (exercises.length === 0) throw new Error('Adicione pelo menos um exercício ao treino.');
            
            const clientId = document.getElementById('client_id').value;
            if(!clientId) throw new Error('Selecione um aluno.');

            const res = await fetch('/workouts/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
                body: JSON.stringify({
                    client_id: clientId,
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    exercises
                })
            });

            const json = await res.json();
            if(json.success) window.location.href = `/admin/clients/${json.clientId}`;
            else throw new Error(json.message);

        } catch (err) {
            alert('Erro: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>

<%- include('../partials/footer.ejs') %>
