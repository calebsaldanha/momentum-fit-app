<%- include('../partials/header') %>
<div class="main-layout">
    <%- include('../partials/admin-sidebar') %>
    
    <main class="content">
        <div class="page-header">
            <a href="/admin/clients/<%= selectedClientId %>" class="back-link">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <h1>Novo Treino</h1>
        </div>

        <div class="workout-form-container">
            <form id="createWorkoutForm">
                <section class="form-section">
                    <h2>Informações do Treino</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client_id">Aluno</label>
                            <select name="client_id" id="client_id" required>
                                <option value="" disabled <%= !selectedClientId ? 'selected' : '' %>>Selecione o aluno...</option>
                                <% clients.forEach(client => { %>
                                    <option value="<%= client.id %>" <%= selectedClientId == client.id ? 'selected' : '' %>>
                                        <%= client.name %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="title">Título do Treino</label>
                            <input type="text" id="title" name="title" placeholder="Ex: Treino A - Superiores" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Descrição / Foco</label>
                        <textarea id="description" name="description" rows="2" placeholder="Objetivo deste treino..."></textarea>
                    </div>
                </section>

                <section class="form-section">
                    <div class="section-header">
                        <h2>Exercícios</h2>
                        <button type="button" id="addExerciseBtn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Exercício
                        </button>
                    </div>
                    
                    <div id="exercisesList" class="exercises-list">
                        </div>
                </section>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Salvar Treino
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<template id="exerciseTemplate">
    <div class="exercise-card">
        <div class="exercise-header">
            <span class="exercise-number">#1</span>
            <button type="button" class="btn-icon delete remove-exercise" title="Remover">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="exercise-body">
            <div class="form-group">
                <label>Nome do Exercício</label>
                <input type="text" class="ex-name" required placeholder="Ex: Supino Reto">
            </div>
            <div class="form-row three-cols">
                <div class="form-group">
                    <label>Séries</label>
                    <input type="text" class="ex-sets" required placeholder="Ex: 4">
                </div>
                <div class="form-group">
                    <label>Repetições</label>
                    <input type="text" class="ex-reps" required placeholder="Ex: 10-12">
                </div>
                <div class="form-group">
                    <label>Descanso (s)</label>
                    <input type="text" class="ex-rest" placeholder="Ex: 60">
                </div>
            </div>
            <div class="form-group">
                <label>Observações / Técnica</label>
                <input type="text" class="ex-notes" placeholder="Detalhes de execução...">
            </div>
            <div class="form-group">
                <label>Link de Vídeo (Opcional)</label>
                <input type="url" class="ex-video" placeholder="https://youtube.com/...">
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const exercisesList = document.getElementById('exercisesList');
    const addBtn = document.getElementById('addExerciseBtn');
    const form = document.getElementById('createWorkoutForm');
    const template = document.getElementById('exerciseTemplate');

    // Função para adicionar exercício
    addBtn.addEventListener('click', () => {
        const clone = template.content.cloneNode(true);
        const index = exercisesList.children.length + 1;
        clone.querySelector('.exercise-number').textContent = '#' + index;
        
        // Botão remover
        clone.querySelector('.remove-exercise').addEventListener('click', (e) => {
            e.target.closest('.exercise-card').remove();
            updateNumbers();
        });

        exercisesList.appendChild(clone);
    });

    // Atualiza numeração ao remover
    function updateNumbers() {
        Array.from(exercisesList.children).forEach((card, idx) => {
            card.querySelector('.exercise-number').textContent = '#' + (idx + 1);
        });
    }

    // Adiciona um exercício inicial por padrão
    addBtn.click();

    // Envio do formulário
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        try {
            // Coletar dados dos exercícios
            const exerciseCards = document.querySelectorAll('.exercise-card');
            const exercises = Array.from(exerciseCards).map((card, index) => ({
                name: card.querySelector('.ex-name').value,
                sets: card.querySelector('.ex-sets').value,
                reps: card.querySelector('.ex-reps').value,
                notes: card.querySelector('.ex-notes').value + (card.querySelector('.ex-rest').value ? ` | Descanso: ${card.querySelector('.ex-rest').value}s` : ''),
                video_url: card.querySelector('.ex-video').value,
                order_index: index
            }));

            if (exercises.length === 0) {
                alert('Adicione pelo menos um exercício.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Treino';
                return;
            }

            const payload = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                exercises: exercises
            };

            const response = await fetch('/workouts/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Incluir CSRF token se estiver usando
                    'CSRF-Token': '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                // Redireciona para o detalhe do cliente
                window.location.href = `/admin/clients/${result.clientId}`;
            } else {
                alert('Erro ao salvar: ' + (result.message || 'Erro desconhecido'));
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Treino';
            }
        } catch (error) {
            console.error(error);
            alert('Erro de conexão ao salvar treino.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Treino';
        }
    });
});
</script>

<style>
/* Estilos específicos para o form dinâmico */
.workout-form-container {
    max-width: 800px;
    background: white;
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #eee;
}
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.exercise-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    position: relative;
}
.exercise-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
}
.exercise-number {
    font-weight: bold;
    color: var(--primary-color);
    background: rgba(37, 99, 235, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
}
.three-cols {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
}
</style>
<%- include('../partials/footer') %>
