<%- include('../partials/header.ejs', { title, bodyClass: 'dashboard-body' }) %>
<div class="dashboard-container">
    <aside class="dashboard-sidebar">
        <nav class="sidebar-nav">
             <% if (user.role === 'client') { %>
                <a href="/client/dashboard" class="nav-item"><span></span> Dashboard</a>
                <a href="/client/workouts" class="nav-item"><span></span> Meus Treinos</a>
                <a href="/chat" class="nav-item active"><span></span> Chat</a>
                <a href="/client/profile" class="nav-item"><span></span> Meu Perfil</a>
            <% } else { %>
                 <% if (user.role === 'superadmin') { %>
                    <a href="/superadmin/dashboard" class="nav-item" style="color: var(--c-accent-dark); background: #eaff0040; border-left-color: var(--c-accent-primary);"><span></span> Painel Super Admin</a>
                    <div style="height: 1px; background: #e2e8f0; margin: 0.5rem 1rem;"></div>
                <% } %>
                <a href="/admin/dashboard" class="nav-item"><span></span> Dashboard</a>
                <a href="/admin/clients" class="nav-item"><span></span> Clientes</a>
                <a href="/workouts/create" class="nav-item"><span></span> Criar Treino</a>
                <% if (user.role === 'superadmin') { %>
                    <a href="/articles/create" class="nav-item"><span></span> Criar Artigo</a>
                <% } %>
                <a href="/chat" class="nav-item active"><span></span> Chat</a>
            <% } %>
        </nav>
        <div class="sidebar-footer">
            <form action="/auth/logout" method="POST" style="margin: 0;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn-logout-sidebar">Sair</button>
            </form>
        </div>
    </aside>
    <main class="dashboard-main">
        <div class="section" style="padding: 0; overflow: hidden; border: 1px solid var(--c-border); height: calc(100vh - 140px);">
            <div class="chat-layout">
                <div class="chat-users">
                    <h3 style="padding: 1rem; border-bottom: 1px solid var(--c-border); margin: 0;">Conversas</h3>
                    <div class="users-list" style="overflow-y: auto; height: 100%;">
                        <% if (chatUsers && chatUsers.length > 0) { %>
                            <% chatUsers.forEach(chatUser => { %>
                                <div class="user-item" data-user-id="<%= chatUser.id %>" data-user-name="<%= chatUser.name %>">
                                    <div class="user-avatar"><%= chatUser.name.charAt(0) %></div>
                                    <div class="user-info"><h4 style="margin: 0; font-size: 0.95rem;"><%= chatUser.name %></h4></div>
                                </div>
                            <% }); %>
                        <% } else { %><p style="padding: 1rem; text-align: center;">Nenhum contato.</p><% } %>
                    </div>
                </div>
                <div class="chat-messages-area">
                    <div class="messages-header"><h3 id="currentChatUser" style="margin: 0; padding: 1rem; font-size: 1.1rem;">Selecione uma conversa</h3></div>
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <img src="/images/logo-3d.png" style="width: 80px; height: 80px; opacity: 0.3; border-radius: 50%; margin-bottom: 1rem;">
                            <p>Escolha algu√©m ao lado.</p>
                        </div>
                    </div>
                    
                    <div id="filePreview" style="display: none; padding: 0.5rem 1rem; background: rgba(255,255,255,0.05); border-top: 1px solid var(--c-border); align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem;">Ì≥é</span>
                            <span id="fileName" style="font-size: 0.85rem; color: var(--c-accent-primary);"></span>
                        </div>
                        <button type="button" id="clearFileBtn" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>

                    <div class="message-input-container">
                        <form id="chatForm" style="display: flex; gap: 10px; width: 100%; padding: 1rem; align-items: center;" enctype="multipart/form-data">
                            <label for="fileInput" class="btn-attach" style="cursor: pointer; padding: 0.5rem; color: var(--c-text-secondary); display: flex; align-items: center; transition: color 0.2s;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            </label>
                            <input type="file" id="fileInput" name="file" accept="image/*,video/*" style="display: none;">
                            
                            <input type="text" id="messageInput" name="content" placeholder="Mensagem..." autocomplete="off" style="flex: 1; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px;">
                            <button type="submit" id="sendBtn" class="btn btn-primary">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUserId = '<%= user.id %>';
    let activeContactId = null;
    const csrfToken = '<%= csrfToken %>'; 
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileNameSpan = document.getElementById('fileName');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const currentChatUserEl = document.getElementById('currentChatUser');
    const sendBtn = document.getElementById('sendBtn');

    function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }

    function renderMessageContent(msg) {
        if (msg.message_type === 'image') {
            return \`<a href="\${msg.content}" target="_blank"><img src="\${msg.content}" alt="Imagem" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover;"></a>\`;
        } else if (msg.message_type === 'video') {
            return \`<video src="\${msg.content}" controls style="max-width: 250px; border-radius: 8px;"></video>\`;
        } else {
            return msg.content;
        }
    }

    async function loadMessages(contactId) {
        try {
            const response = await fetch(\`/chat/messages/\${contactId}\`);
            if (!response.ok) throw new Error('Erro');
            const messages = await response.json();
            messagesContainer.innerHTML = '';
            if (messages.length === 0) { 
                messagesContainer.innerHTML = '<div style="padding:2rem;text-align:center;color:#777;"><p>Nenhuma mensagem.</p></div>';
            } else { 
                messages.forEach(msg => { 
                    const d = document.createElement('div'); 
                    d.className = 'message ' + (msg.sender_id == currentUserId ? 'own-message' : 'other-message'); 
                    d.innerHTML = renderMessageContent(msg); 
                    messagesContainer.appendChild(d); 
                });
            }
            scrollToBottom();
        } catch (error) { console.error(error); }
    }

    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            filePreview.style.display = 'flex';
            fileNameSpan.textContent = this.files[0].name;
            messageInput.placeholder = 'Adicione uma legenda (opcional)...';
        }
    });

    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileNameSpan.textContent = '';
        messageInput.placeholder = 'Mensagem...';
    });

    document.querySelectorAll('.user-item').forEach(item => { 
        item.addEventListener('click', () => { 
            activeContactId = item.dataset.userId; 
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active')); 
            item.classList.add('active'); 
            currentChatUserEl.textContent = item.dataset.userName; 
            loadMessages(activeContactId); 
        }); 
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!activeContactId) {
            alert("Selecione uma conversa primeiro.");
            return;
        }

        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;

        if (!hasText && !hasFile) return;

        // Feedback de envio
        const originalBtnText = sendBtn.innerText;
        sendBtn.innerText = 'Enviando...';
        sendBtn.disabled = true;

        const formData = new FormData();
        formData.append('receiver_id', activeContactId);
        if (hasText) formData.append('content', messageInput.value.trim());
        if (hasFile) formData.append('file', fileInput.files[0]);

        try {
             const response = await fetch('/chat/send', { 
                 method: 'POST', 
                 headers: { 'CSRF-Token': csrfToken }, 
                 body: formData 
             });
             
            if (response.ok) { 
                const msg = await response.json(); 
                const d = document.createElement('div'); 
                d.className = 'message own-message'; 
                d.innerHTML = renderMessageContent(msg); 
                messagesContainer.appendChild(d); 
                
                // Reset
                messageInput.value = ''; 
                fileInput.value = '';
                filePreview.style.display = 'none';
                messageInput.placeholder = 'Mensagem...';
                scrollToBottom(); 
            } else {
                const err = await response.json();
                alert("Erro ao enviar: " + (err.error || 'Desconhecido'));
            }
        } catch (err) { console.error(err); alert('Erro de conex√£o.'); }
        finally {
            sendBtn.innerText = originalBtnText;
            sendBtn.disabled = false;
        }
    });
});
</script>
<%- include('../partials/footer.ejs') %>
