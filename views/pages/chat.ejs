<%- include('../partials/header.ejs', { title, bodyClass: 'dashboard-body' }) %>

<div class="dashboard-container">
    <aside class="dashboard-sidebar">
        <nav class="sidebar-nav">
             <% if (user.role === 'client') { %>
                <a href="/client/dashboard" class="nav-item"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Dashboard</a>
                <a href="/client/workouts" class="nav-item"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Meus Treinos</a>
                <a href="/chat" class="nav-item active"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Chat</a>
            <% } else { %>
                <a href="/admin/dashboard" class="nav-item"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Dashboard</a>
                <a href="/admin/clients" class="nav-item"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Clientes</a>
                <a href="/chat" class="nav-item active"><span><img src="/images/momentum-fit-icon.png" class="icon-sm"></span> Chat</a>
            <% } %>
        </nav>
    </aside>

    <main class="dashboard-main">
        <div class="section" style="padding: 0; overflow: hidden; border: 1px solid var(--c-border);">
            <div class="chat-layout">
                <div class="chat-users">
                    <h3 style="padding: 1rem; border-bottom: 1px solid var(--c-border); margin: 0;">Conversas</h3>
                    <div class="users-list" style="overflow-y: auto; height: 100%;">
                        <% if (chatUsers && chatUsers.length > 0) { %>
                            <% chatUsers.forEach(chatUser => { %>
                                <div class="user-item" data-user-id="<%= chatUser.id %>" data-user-name="<%= chatUser.name %>">
                                    <div class="user-avatar" style="background: var(--c-accent-primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;"><%= chatUser.name.charAt(0) %></div>
                                    <div class="user-info">
                                        <h4 style="margin: 0; font-size: 0.95rem;"><%= chatUser.name %></h4>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p style="padding: 1rem; text-align: center; color: var(--c-text-secondary);">Nenhum contato dispon√≠vel.</p>
                        <% } %>
                    </div>
                </div>

                <div class="chat-messages-area">
                    <div class="messages-header">
                        <h3 id="currentChatUser" style="margin: 0; padding: 1rem; font-size: 1.1rem;">Selecione uma conversa</h3>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                         <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                             <div style="font-size: 3rem;"><img src="/images/momentum-fit-icon.png" style="width: 60px; opacity: 0.5;"></div>
                             <p>Escolha algu√©m ao lado para conversar.</p>
                        </div>
                    </div>
                    
                    <div class="message-input-container">
                        <form id="chatForm" style="display: flex; gap: 10px; width: 100%; padding: 1rem;">
                            <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;">
                            <label for="fileInput" class="btn btn-secondary" style="padding: 0.8rem; display: flex; align-items: center; margin:0;">Ì≥é</label>
                            <input type="text" id="messageInput" placeholder="Digite sua mensagem..." autocomplete="off" style="flex: 1; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px;">
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUserId = '<%= user.id %>';
    let activeContactId = null;
    const csrfToken = '<%= csrfToken %>';
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const currentChatUserEl = document.getElementById('currentChatUser');
    const fileInput = document.getElementById('fileInput');

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function loadMessages(contactId) {
        try {
            const response = await fetch(`/chat/messages/${contactId}`);
            if (!response.ok) throw new Error('Erro');
            const messages = await response.json();
            
            messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                 messagesContainer.innerHTML = '<div class="empty-state" style="padding: 2rem; text-align: center; color: #777;"><p>Nenhuma mensagem ainda.</p></div>';
            } else {
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.classList.add(msg.sender_id == currentUserId ? 'own-message' : 'other-message');
        
                    if (msg.message_type === 'image') {
                        messageDiv.innerHTML = `<img src="${msg.content}" style="max-width: 200px; border-radius: 8px;">`;
                        messageDiv.style.background = 'transparent';
                        messageDiv.style.padding = '0';
                    } else {
                        messageDiv.textContent = msg.content;
                    }
                    messagesContainer.appendChild(messageDiv);
                });
            }
            scrollToBottom();
        } catch (error) {
            console.error(error);
        }
    }

    document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', () => {
            activeContactId = item.dataset.userId;
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');
            currentChatUserEl.textContent = item.dataset.userName;
            loadMessages(activeContactId);
        });
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content || !activeContactId) return;

        try {
             const response = await fetch('/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrfToken },
                body: JSON.stringify({ receiver_id: activeContactId, content: content, message_type: 'text' })
            });
            if (response.ok) {
                const msg = await response.json();
                const div = document.createElement('div');
                div.className = 'message own-message';
                div.textContent = msg.content;
                messagesContainer.appendChild(div);
                messageInput.value = '';
                scrollToBottom();
            }
        } catch (err) { console.error(err); }
    });
});
</script>
<%- include('../partials/footer.ejs') %>
