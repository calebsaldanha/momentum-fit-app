<%- include('../partials/header.ejs', { title, bodyClass: 'dashboard-body' }) %>

<style>
    #imageModal {
        display: none; /* Escondido por padr√£o */
        position: fixed; 
        z-index: 2000; /* Fica sobre tudo */
        padding-top: 50px; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.9); /* Fundo preto transparente */
    }
    #modalImage {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90vh;
        border-radius: 8px;
        border: 2px solid var(--c-border);
    }
    #closeModal {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
    }
    #closeModal:hover,
    #closeModal:focus {
        color: var(--c-accent-primary);
        text-decoration: none;
        cursor: pointer;
    }
</style>

<div id="imageModal">
  <span id="closeModal">&times;</span>
  <img id="modalImage">
</div>

<div class="dashboard-container">
    <aside class="dashboard-sidebar">
        <nav class="sidebar-nav">
             <% if (user.role === 'client') { %>
                <a href="/client/dashboard" class="nav-item"><span></span> Dashboard</a>
                <a href="/client/workouts" class="nav-item"><span></span> Meus Treinos</a>
                <a href="/chat" class="nav-item active"><span></span> Chat</a>
                <a href="/client/profile" class="nav-item"><span></span> Meu Perfil</a>
            <% } else { %>
                 <% if (user.role === 'superadmin') { %>
                    <a href="/superadmin/dashboard" class="nav-item" style="color: var(--c-accent-dark); background: #eaff0040; border-left-color: var(--c-accent-primary);"><span></span> Painel Super Admin</a>
                    <div style="height: 1px; background: #e2e8f0; margin: 0.5rem 1rem;"></div>
                <% } %>
                <a href="/admin/dashboard" class="nav-item"><span></span> Dashboard</a>
                <a href="/admin/clients" class="nav-item"><span></span> Clientes</a>
                <a href="/workouts/create" class="nav-item"><span></span> Criar Treino</a>
                <% if (user.role === 'superadmin') { %>
                    <a href="/articles/create" class="nav-item"><span></span> Criar Artigo</a>
                <% } %>
                <a href="/chat" class="nav-item active"><span></span> Chat</a>
            <% } %>
        </nav>
        <div class="sidebar-footer">
            <form action="/auth/logout" method="POST" style="margin: 0;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn-logout-sidebar">Sair</button>
            </form>
        </div>
    </aside>
    <main class="dashboard-main">
        <div class="section" style="padding: 0; overflow: hidden; border: 1px solid var(--c-border); height: calc(100vh - 140px);">
            <div class="chat-layout">
                <div class="chat-users">
                    <h3 style="padding: 1rem; border-bottom: 1px solid var(--c-border); margin: 0;">Conversas</h3>
                    <div class="users-list" style="overflow-y: auto; height: 100%;">
                        <% if (chatUsers && chatUsers.length > 0) { %>
                            <% chatUsers.forEach(chatUser => { %>
                                <div class="user-item" data-user-id="<%= chatUser.id %>" data-user-name="<%= chatUser.name %>">
                                    <div class="user-avatar"><%= chatUser.name.charAt(0) %></div>
                                    <div class="user-info"><h4 style="margin: 0; font-size: 0.95rem;"><%= chatUser.name %></h4></div>
                                </div>
                            <% }); %>
                        <% } else { %><p style="padding: 1rem; text-align: center;">Nenhum contato.</p><% } %>
                    </div>
                </div>

                <div class="chat-messages-area">
                    <div class="messages-header"><h3 id="currentChatUser" style="margin: 0; padding: 1rem; font-size: 1.1rem;">Selecione uma conversa</h3></div>
                    
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <img src="/images/logo-3d.png" style="width: 80px; height: 80px; opacity: 0.3; border-radius: 50%; margin-bottom: 1rem; object-fit: cover;">
                            <p>Escolha algu√©m ao lado para come√ßar.</p>
                        </div>
                    </div>
                    
                    <div id="filePreview" style="display: none; padding: 0.8rem; background: rgba(255,255,255,0.05); border-top: 1px solid var(--c-border); align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px; overflow: hidden;">
                            <span style="font-size: 1.2rem;">Ì≥é</span>
                            <span id="fileName" style="font-size: 0.9rem; color: var(--c-accent-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;"></span>
                        </div>
                        <button type="button" id="clearFileBtn" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>

                    <div class="message-input-container">
                        <form id="chatForm" style="display: flex; gap: 10px; width: 100%; align-items: center;" enctype="multipart/form-data">
                            <label for="fileInput" class="btn-attach" style="cursor: pointer; padding: 0.5rem; color: var(--c-text-secondary); display: flex; align-items: center; transition: color 0.2s;" title="Enviar foto ou v√≠deo">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            </label>
                            <input type="file" id="fileInput" name="file" accept="image/*,video/*" style="display: none;">
                            
                            <input type="text" id="messageInput" name="content" placeholder="Digite sua mensagem..." autocomplete="off" style="flex: 1; padding: 0.8rem; border: 1px solid #333; border-radius: 8px; background: #050505; color: white;">
                            <button type="submit" id="sendBtn" class="btn btn-primary">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUserId = '<%= user.id %>';
    let activeContactId = null;
    const csrfToken = '<%= csrfToken %>'; 
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileNameSpan = document.getElementById('fileName');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const currentChatUserEl = document.getElementById('currentChatUser');
    const sendBtn = document.getElementById('sendBtn');
    
    // Elementos do Modal
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeModal = document.getElementById('closeModal');

    function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }

    // Fun√ß√£o para abrir o modal de imagem
    window.openImageModal = function(src) {
        modalImage.src = src;
        imageModal.style.display = "block";
    }

    // Fechar o modal
    closeModal.onclick = function() { imageModal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == imageModal) { imageModal.style.display = "none"; } }

    // Fun√ß√£o para renderizar m√≠dia (Imagens/V√≠deos)
    function renderMessageContent(msg) {
        if (msg.message_type === 'image') {
            // CORRE√á√ÉO: Chama a fun√ß√£o openImageModal em vez de abrir nova aba
            return `<img src="${msg.content}" alt="Imagem" class="chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; border: 1px solid #333; cursor: pointer;" onclick="openImageModal('${msg.content}')">`;
        } else if (msg.message_type === 'video') {
            return `<video src="${msg.content}" controls style="max-width: 250px; border-radius: 8px; border: 1px solid #333;"></video>`;
        } else {
            return msg.content;
        }
    }

    // Carregar Mensagens
    async function loadMessages(contactId) {
        messagesContainer.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#777;"><p>Carregando conversas...</p></div>';
        
        try {
            const response = await fetch(`/chat/messages/${contactId}`);
            if (!response.ok) throw new Error('Erro na rede');
            const messages = await response.json();
            
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) { 
                messagesContainer.innerHTML = '<div style="padding:2rem; text-align:center; color:#555; margin-top:auto;"><p>Nenhuma mensagem ainda. Diga ol√°! Ì±ã</p></div>';
            } else { 
                messages.forEach(msg => { 
                    const d = document.createElement('div'); 
                    d.className = 'message ' + (msg.sender_id == currentUserId ? 'own-message' : 'other-message'); 
                    d.innerHTML = renderMessageContent(msg); 
                    messagesContainer.appendChild(d); 
                });
            }
            scrollToBottom();
        } catch (error) { 
            console.error(error);
            messagesContainer.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--c-error);"><p>Erro ao carregar mensagens.</p></div>';
        }
    }

    // Preview do Arquivo (CORRE√á√ÉO: Sanitiza√ß√£o do Nome)
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            // Remove caracteres n√£o-ASCII (emojis, s√≠mbolos estranhos) para exibi√ß√£o
            let safeName = file.name.replace(/[^\x00-\x7F]/g, ""); 
            if (safeName.length === 0) safeName = "Arquivo"; // Fallback se o nome for s√≥ emoji

            filePreview.style.display = 'flex';
            fileNameSpan.textContent = safeName;
            messageInput.placeholder = 'Adicione uma legenda (opcional)...';
            messageInput.focus();
        }
    });

    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileNameSpan.textContent = '';
        messageInput.placeholder = 'Digite sua mensagem...';
    });

    // Clique no usu√°rio da lista
    document.querySelectorAll('.user-item').forEach(item => { 
        item.addEventListener('click', () => { 
            activeContactId = item.dataset.userId; 
            
            // Atualiza UI
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active')); 
            item.classList.add('active'); 
            currentChatUserEl.textContent = item.dataset.userName; 
            
            // Carrega
            loadMessages(activeContactId); 
        }); 
    });

    // Enviar Mensagem
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!activeContactId) {
            alert("Selecione uma conversa primeiro.");
            return;
        }

        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;

        if (!hasText && !hasFile) return;

        // Feedback de envio
        const originalBtnText = sendBtn.innerText;
        sendBtn.innerText = 'Enviando...';
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.7';

        const formData = new FormData();
        formData.append('receiver_id', activeContactId);
        if (hasText) formData.append('content', messageInput.value.trim());
        if (hasFile) formData.append('file', fileInput.files[0]);

        try {
             const response = await fetch('/chat/send', { 
                 method: 'POST', 
                 headers: { 'CSRF-Token': csrfToken }, 
                 body: formData 
             });
             
            if (response.ok) { 
                const msg = await response.json(); 
                
                // Remove mensagem de "vazio" se houver
                if(messagesContainer.innerText.includes('Nenhuma mensagem')) {
                    messagesContainer.innerHTML = '';
                }

                const d = document.createElement('div'); 
                d.className = 'message own-message'; 
                d.innerHTML = renderMessageContent(msg); 
                messagesContainer.appendChild(d); 
                
                // Reset
                messageInput.value = ''; 
                fileInput.value = '';
                filePreview.style.display = 'none';
                messageInput.placeholder = 'Digite sua mensagem...';
                
                scrollToBottom(); 
            } else {
                const err = await response.json();
                alert("Erro ao enviar: " + (err.error || 'Desconhecido'));
            }
        } catch (err) { 
            console.error(err); 
            alert('Erro de conex√£o.'); 
        } finally {
            sendBtn.innerText = originalBtnText;
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
        }
    });
});
</script>
<%- include('../partials/footer.ejs') %>
