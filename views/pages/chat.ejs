<%- include('../partials/header.ejs', { title, bodyClass: 'dashboard-body' }) %>

<style>
    #imageModal { display: none; position: fixed; z-index: 2000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); }
    #modalImage { margin: auto; display: block; max-width: 90%; max-height: 90vh; border-radius: 8px; border: 2px solid var(--c-border); }
    #closeModal { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
    #closeModal:hover { color: var(--c-accent-primary); }
</style>

<div id="imageModal"><span id="closeModal">&times;</span><img id="modalImage"></div>

<div class="dashboard-container">
    
    <% if (user.role === 'client') { %>
        <%- include('../partials/client-sidebar.ejs') %>
    <% } else { %>
        <%- include('../partials/admin-sidebar.ejs') %>
    <% } %>

    <main class="dashboard-main">
        <div class="section" style="padding: 0; overflow: hidden; border: 1px solid var(--c-border); height: calc(100vh - 140px);">
            <div class="chat-layout">
                <div class="chat-users">
                    <h3 style="padding: 1rem; border-bottom: 1px solid var(--c-border); margin: 0;">Conversas</h3>
                    <div class="users-list" style="overflow-y: auto; height: 100%;">
                        <% if (typeof chatUsers !== 'undefined' && chatUsers.length > 0) { %>
                            <% chatUsers.forEach(chatUser => { %>
                                <div class="user-item" data-user-id="<%= chatUser.id %>" data-user-name="<%= chatUser.name %>">
                                    <div class="user-avatar"><%= chatUser.name.charAt(0) %></div>
                                    <div class="user-info"><h4 style="margin: 0; font-size: 0.95rem;"><%= chatUser.name %></h4></div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p style="padding: 1rem; text-align: center; color: #666;">Nenhum contato dispon√≠vel.</p>
                        <% } %>
                    </div>
                </div>

                <div class="chat-messages-area">
                    <div class="messages-header"><h3 id="currentChatUser" style="margin: 0; padding: 1rem; font-size: 1.1rem;">Selecione uma conversa</h3></div>
                    
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <img src="/images/logo-3d.png" style="width: 80px; height: 80px; opacity: 0.3; border-radius: 50%; margin-bottom: 1rem; object-fit: cover;">
                            <p>Escolha algu√©m ao lado para come√ßar.</p>
                        </div>
                    </div>
                    
                    <div id="filePreview" style="display: none; padding: 0.8rem; background: rgba(255,255,255,0.05); border-top: 1px solid var(--c-border); align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px; overflow: hidden;">
                            <span style="font-size: 1.2rem;">Ì≥é</span>
                            <span id="fileName" style="font-size: 0.9rem; color: var(--c-accent-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;"></span>
                        </div>
                        <button type="button" id="clearFileBtn" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">&times;</button>
                    </div>

                    <div class="message-input-container">
                        <form id="chatForm" style="display: flex; gap: 10px; width: 100%; align-items: center;" enctype="multipart/form-data">
                            <label for="fileInput" class="btn-attach" style="cursor: pointer; padding: 0.5rem; color: var(--c-text-secondary); display: flex; align-items: center;" title="Enviar foto ou v√≠deo">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            </label>
                            <input type="file" id="fileInput" name="file" accept="image/*,video/*" style="display: none;">
                            <input type="text" id="messageInput" name="content" placeholder="Digite sua mensagem..." autocomplete="off" style="flex: 1; padding: 0.8rem; border: 1px solid #333; border-radius: 8px; background: #050505; color: white;">
                            <button type="submit" id="sendBtn" class="btn btn-primary">Enviar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUserId = '<%= user.id %>';
    let activeContactId = null;
    const csrfToken = '<%= typeof csrfToken !== "undefined" ? csrfToken : "" %>'; 
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileNameSpan = document.getElementById('fileName');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const currentChatUserEl = document.getElementById('currentChatUser');
    const sendBtn = document.getElementById('sendBtn');
    
    // Modal
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeModal = document.getElementById('closeModal');

    function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }

    window.openImageModal = function(src) {
        modalImage.src = src;
        imageModal.style.display = "block";
    }
    closeModal.onclick = function() { imageModal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == imageModal) imageModal.style.display = "none"; }

    function renderMessageContent(msg) {
        if (msg.message_type === 'image') {
            return `<img src="${msg.content}" alt="Imagem" class="chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; border: 1px solid #333; cursor: pointer;" onclick="openImageModal('${msg.content}')">`;
        } else if (msg.message_type === 'video') {
            return `<video src="${msg.content}" controls style="max-width: 250px; border-radius: 8px; border: 1px solid #333;"></video>`;
        } else {
            return msg.content;
        }
    }

    async function loadMessages(contactId) {
        messagesContainer.innerHTML = '<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#777;"><p>Carregando...</p></div>';
        try {
            const response = await fetch(`/chat/messages/${contactId}`);
            if (!response.ok) throw new Error('Erro na rede');
            const messages = await response.json();
            
            messagesContainer.innerHTML = '';
            if (messages.length === 0) { 
                messagesContainer.innerHTML = '<div style="padding:2rem; text-align:center; color:#555; margin-top:auto;"><p>Nenhuma mensagem ainda.</p></div>';
            } else { 
                messages.forEach(msg => { 
                    const d = document.createElement('div'); 
                    d.className = 'message ' + (msg.sender_id == currentUserId ? 'own-message' : 'other-message'); 
                    d.innerHTML = renderMessageContent(msg); 
                    messagesContainer.appendChild(d); 
                });
            }
            scrollToBottom();
        } catch (error) { 
            console.error(error);
            messagesContainer.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--c-error);"><p>Erro ao carregar mensagens.</p></div>';
        }
    }

    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            let safeName = this.files[0].name.replace(/[^\x00-\x7F]/g, "") || "Arquivo"; 
            filePreview.style.display = 'flex';
            fileNameSpan.textContent = safeName;
            messageInput.placeholder = 'Legenda (opcional)...';
            messageInput.focus();
        }
    });

    clearFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileNameSpan.textContent = '';
        messageInput.placeholder = 'Digite sua mensagem...';
    });

    document.querySelectorAll('.user-item').forEach(item => { 
        item.addEventListener('click', () => { 
            activeContactId = item.dataset.userId; 
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active')); 
            item.classList.add('active'); 
            currentChatUserEl.textContent = item.dataset.userName; 
            loadMessages(activeContactId); 
        }); 
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!activeContactId) { alert("Selecione uma conversa."); return; }

        const hasText = messageInput.value.trim().length > 0;
        const hasFile = fileInput.files.length > 0;
        if (!hasText && !hasFile) return;

        const originalBtnText = sendBtn.innerText;
        sendBtn.innerText = '...';
        sendBtn.disabled = true;

        const formData = new FormData();
        formData.append('receiver_id', activeContactId);
        if (hasText) formData.append('content', messageInput.value.trim());
        if (hasFile) formData.append('file', fileInput.files[0]);

        try {
             const response = await fetch('/chat/send', { method: 'POST', headers: { 'CSRF-Token': csrfToken }, body: formData });
             if (response.ok) { 
                const msg = await response.json();
                if(messagesContainer.innerText.includes('Nenhuma mensagem')) messagesContainer.innerHTML = '';
                
                const d = document.createElement('div');
                d.className = 'message own-message'; 
                d.innerHTML = renderMessageContent(msg); 
                messagesContainer.appendChild(d); 
                
                messageInput.value = '';
                fileInput.value = '';
                filePreview.style.display = 'none';
                messageInput.placeholder = 'Digite sua mensagem...';
                scrollToBottom();
            } else {
                alert("Erro ao enviar.");
            }
        } catch (err) { console.error(err); alert('Erro de conex√£o.'); } 
        finally { sendBtn.innerText = originalBtnText; sendBtn.disabled = false; }
    });
});
</script>
<%- include('../partials/footer.ejs') %>
