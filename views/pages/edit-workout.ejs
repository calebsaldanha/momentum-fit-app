<%- include('../partials/header') %>

<style>
    .workout-builder {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
        height: calc(100vh - 120px);
    }
    .builder-main { overflow-y: auto; padding-right: 1rem; }
    .builder-sidebar {
        background: #1a1a1a;
        border-left: 1px solid #333;
        padding: 1.5rem;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    .exercise-library-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        overflow-y: auto;
        padding-right: 5px;
        flex-grow: 1;
    }
    .library-item {
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .library-item:hover { transform: translateY(-2px); border-color: var(--c-accent-primary); }
    .library-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        background: #000;
    }
    .library-item .info { padding: 0.5rem; }
    .library-item .name { font-size: 0.85rem; font-weight: 600; color: #fff; }
    .library-item .category { font-size: 0.7rem; color: #888; }
    
    .exercise-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        align-items: center;
    }
    .exercise-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
</style>

<div class="dashboard-container">
    <%- include('../partials/sidebar') %>

    <main class="main-content">
        <form id="workoutForm" action="/workouts/edit/<%= workout.id %>" method="POST" class="workout-builder">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" id="exercisesInput" name="exercises" value='<%= JSON.stringify(exercises || []) %>'>

            <div class="builder-main">
                <div class="section-header">
                    <h1>Editar Treino</h1>
                    <div class="actions">
                        <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </div>

                <div class="content-card">
                    <div class="form-group">
                        <label>Título do Treino</label>
                        <input type="text" name="title" class="form-control" value="<%= workout.title %>" required>
                    </div>
                    <div class="form-group">
                        <label>Descrição</label>
                        <textarea name="description" class="form-control" rows="2"><%= workout.description %></textarea>
                    </div>
                </div>

                <h3 style="margin-top: 1.5rem;">Exercícios Selecionados</h3>
                <div id="selectedExercisesList" class="selected-exercises"></div>
            </div>

            <aside class="builder-sidebar">
                <h3 style="color: var(--c-accent-primary); margin-bottom: 1rem;">Biblioteca</h3>
                <input type="text" id="searchBox" placeholder="Buscar..." class="form-control" style="margin-bottom: 1rem;" onkeyup="filterLibrary()">
                
                <div class="exercise-library-grid">
                    <% if(typeof exerciseLibrary !== "undefined") { %>
                        <% exerciseLibrary.forEach(ex => { %>
                            <div class="library-item" onclick="addExercise('<%= ex.id %>', '<%= ex.name %>', '<%= ex.image_url %>')" data-name="<%= ex.name.toLowerCase() %>">
                                <img src="<%= ex.image_url || '/images/default-exercise.png' %>" onerror="this.src='/images/default-exercise.png'">
                                <div class="info">
                                    <div class="name"><%= ex.name %></div>
                                    <div class="category"><%= ex.category %></div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </aside>
        </form>
    </main>
</div>

<script>
    let selectedExercises = <%- JSON.stringify(exercises || []) %>;
    
    function renderExercises() {
        const list = document.getElementById('selectedExercisesList');
        const input = document.getElementById('exercisesInput');
        list.innerHTML = '';
        
        selectedExercises.forEach((ex, index) => {
            ex.order_index = index;
            const img = ex.image_url || '/images/default-exercise.png';
            
            list.innerHTML += `
                <div class="exercise-card">
                    <img src="${img}" onerror="this.src='/images/default-exercise.png'">
                    <div>
                        <h4 style="color:white; margin:0 0 5px 0;">${ex.name}</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="text" placeholder="Séries (ex: 3)" value="${ex.sets || ''}" class="form-control" onchange="updateEx(${index}, 'sets', this.value)">
                            <input type="text" placeholder="Reps (ex: 12)" value="${ex.reps || ''}" class="form-control" onchange="updateEx(${index}, 'reps', this.value)">
                        </div>
                        <input type="text" placeholder="Obs / Técnica" value="${ex.notes || ''}" class="form-control" style="margin-top:5px;" onchange="updateEx(${index}, 'notes', this.value)">
                    </div>
                    <button type="button" class="btn-icon delete" onclick="removeEx(${index})"><i class="fas fa-times"></i></button>
                </div>
            `;
        });
        
        // Atualiza o input hidden para enviar ao backend
        input.value = JSON.stringify(selectedExercises);
    }

    function addExercise(id, name, img) {
        selectedExercises.push({
            name: name,
            sets: '3',
            reps: '12',
            notes: '',
            image_url: img
        });
        renderExercises();
    }

    function removeEx(index) {
        selectedExercises.splice(index, 1);
        renderExercises();
    }

    function updateEx(index, field, value) {
        selectedExercises[index][field] = value;
        document.getElementById('exercisesInput').value = JSON.stringify(selectedExercises);
    }

    function filterLibrary() {
        const term = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.library-item').forEach(item => {
            item.style.display = item.dataset.name.includes(term) ? 'block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', renderExercises);
    
    // Intercepta submit para garantir JSON atualizado
    document.getElementById('workoutForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
            title: this.title.value,
            description: this.description.value,
            exercises: selectedExercises
        };
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': this.querySelector('[name=_csrf]').value
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) window.location.href = '/admin/clients/' + data.clientId;
            else alert('Erro: ' + data.message);
        })
        .catch(err => alert('Erro de conexão'));
    });
</script>
<%- include('../partials/footer') %>
