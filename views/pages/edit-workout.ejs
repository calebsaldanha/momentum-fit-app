<%- include('../partials/header.ejs', { title: 'Editar Treino', bodyClass: 'dashboard-body' }) %>

<div class="dashboard-container">
    <%- include('../partials/sidebar.ejs', { currentPage: 'create-workout' }) %>
    
    <main class="dashboard-main">
        <div class="section">
            <div class="section-header">
                <h1>Editar Treino</h1>
                <a href="/admin/clients/<%= workout.client_id %>" class="btn btn-outline btn-sm">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <form id="editWorkoutForm" class="dashboard-form" style="max-width: 100%;">
                
                <div class="form-group">
                    <label for="title">Título do Treino</label>
                    <input type="text" id="title" name="title" value="<%= workout.title %>" placeholder="Ex: Treino A - Superiores" required>
                </div>

                <div class="form-group">
                    <label for="description">Descrição / Foco</label>
                    <textarea id="description" name="description" rows="2" placeholder="Objetivo deste treino..."><%= workout.description %></textarea>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid var(--c-border); padding-top: 20px;">
                    
                    <button type="button" onclick="openLibraryModal()" class="btn btn-outline" style="width: 100%; padding: 20px; border-style: dashed; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.1rem; margin-bottom: 20px;">
                        <i class="fas fa-images"></i> <strong>Abrir Biblioteca de Exercícios</strong>
                    </button>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--c-accent-primary);">Exercícios Selecionados</h3>
                        <button type="button" id="addExerciseBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-plus"></i> Adicionar Manual
                        </button>
                    </div>
                    
                    <div id="exercisesList"></div>
                </div>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                        <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<div id="libraryModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1000px; margin: 0 auto; background: #111; border-radius: 12px; display: flex; flex-direction: column; height: 90vh; border: 1px solid #333;">
        
        <div style="padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; border-radius: 12px 12px 0 0;">
            <div>
                <h2 style="margin: 0; color: white;">Biblioteca de Exercícios</h2>
                <p style="margin: 5px 0 0; color: #888; font-size: 0.9rem;">Selecione os exercícios para adicionar.</p>
            </div>
            <button onclick="closeLibraryModal()" style="background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px; background: #111;">
            <div style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                <input type="text" id="searchLibrary" placeholder="Buscar..." style="width: 100%; padding: 15px 15px 15px 45px; background: #000; border: 1px solid #444; color: white; border-radius: 8px; font-size: 1rem;">
            </div>
        </div>
        
        <div id="libraryGrid" style="flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; align-content: start;">
        </div>

        <div style="padding: 20px; border-top: 1px solid #333; background: #1a1a1a; border-radius: 0 0 12px 12px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #ccc;">
                <span id="selectedCount" style="color: var(--c-accent-primary); font-weight: bold; font-size: 1.2rem;">0</span> selecionados
            </div>
            <button onclick="addSelectedExercises()" class="btn btn-primary" style="padding: 10px 30px;">
                Adicionar ao Treino <i class="fas fa-check-circle" style="margin-left: 5px;"></i>
            </button>
        </div>
    </div>
</div>

<template id="exerciseTemplate">
    <div class="exercise-card" style="background: var(--c-bg-card); border: 1px solid var(--c-border); padding: 20px; border-radius: 8px; margin-bottom: 15px; position: relative; display: grid; grid-template-columns: 100px 1fr; gap: 20px; align-items: start;">
        <div class="ex-image-preview" style="width: 100px; height: 100px; background: #000; border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #333;">
            <i class="fas fa-dumbbell" style="color: #444; font-size: 1.5rem;"></i>
        </div>
        <input type="hidden" class="ex-image-url">

        <div style="width: 100%;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span class="exercise-number" style="background: var(--c-accent-primary); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold;">#1</span>
                <button type="button" class="remove-exercise" style="background: none; border: none; color: var(--c-error); cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="form-group">
                <input type="text" class="ex-name" required placeholder="Nome do Exercício" style="font-weight: bold; font-size: 1.1rem; width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; color: var(--c-text-primary); padding: 5px 0;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;">
                <input type="text" class="ex-sets" required placeholder="Séries" style="background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
                <input type="text" class="ex-reps" required placeholder="Reps" style="background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
                <input type="text" class="ex-rest" placeholder="Descanso" style="background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
            </div>
            
            <input type="text" class="ex-notes" placeholder="Observações..." style="margin-top: 10px; width: 100%; background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
            <input type="url" class="ex-video" placeholder="Link Vídeo (YouTube)" style="margin-top: 10px; width: 100%; background:#111; border:1px solid #333; color:white; padding:8px; border-radius:4px;">
        </div>
    </div>
</template>

<style>
    .lib-item { background: #222; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid #333; transition: all 0.2s; position: relative; display: flex; flex-direction: column; min-height: 200px; }
    .lib-item:hover { transform: translateY(-2px); border-color: var(--c-accent-primary); }
    .lib-item.selected { border-color: var(--c-accent-primary); background: rgba(37, 99, 235, 0.1); }
    .lib-item.selected::after { content: '\f00c'; font-family: 'Font Awesome 5 Free'; font-weight: 900; position: absolute; top: 10px; right: 10px; background: var(--c-accent-primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .lib-img { width: 100%; height: 120px; object-fit: cover; background: #000; display: block; }
    .lib-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .lib-name { font-weight: 600; margin-bottom: 4px; color: #fff; font-size: 0.95rem; }
    .lib-desc { font-size: 0.8rem; color: #999; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
    .lib-category { display: inline-block; font-size: 0.7rem; background: #333; color: #ccc; padding: 2px 6px; border-radius: 4px; margin-bottom: 6px; align-self: flex-start; }
</style>

<script>
    // Dados injetados pelo EJS
    let rawLibrary = <%- JSON.stringify(typeof exerciseLibrary !== 'undefined' ? exerciseLibrary : []) %>;
    const libraryData = Array.isArray(rawLibrary) ? rawLibrary : [];
    
    const existingExercises = <%- JSON.stringify(typeof exercises !== 'undefined' ? exercises : []) %>;
    const workoutId = '<%= workout.id %>';

    // Elementos DOM
    const exercisesList = document.getElementById('exercisesList');
    const template = document.getElementById('exerciseTemplate');
    const libraryModal = document.getElementById('libraryModal');
    const libraryGrid = document.getElementById('libraryGrid');
    const searchInput = document.getElementById('searchLibrary');
    const selectedCountSpan = document.getElementById('selectedCount');
    let selectedExercises = new Set(); 

    // Função para criar card de exercício
    function addExerciseCard(data = null) {
        const clone = template.content.cloneNode(true);
        const index = exercisesList.children.length + 1;
        
        clone.querySelector('.exercise-number').textContent = '#' + index;
        if(data) {
            clone.querySelector('.ex-name').value = data.name || '';
            clone.querySelector('.ex-sets').value = data.sets || '';
            clone.querySelector('.ex-reps').value = data.reps || '';
            clone.querySelector('.ex-video').value = data.video_url || '';
            
            // Lógica para preencher notas/descrição corretamente
            clone.querySelector('.ex-notes').value = data.notes || data.description || '';
            
            if(data.image_url) {
                clone.querySelector('.ex-image-url').value = data.image_url;
                const imgContainer = clone.querySelector('.ex-image-preview');
                imgContainer.innerHTML = `<img src="${data.image_url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'">`;
            }
        }

        clone.querySelector('.remove-exercise').addEventListener('click', (e) => {
            e.target.closest('.exercise-card').remove();
            updateNumbers();
        });
        exercisesList.appendChild(clone);
    }

    function updateNumbers() {
        Array.from(exercisesList.children).forEach((card, idx) => {
            card.querySelector('.exercise-number').textContent = '#' + (idx + 1);
        });
    }

    // Inicialização: carrega exercícios existentes
    document.addEventListener('DOMContentLoaded', () => {
        if(existingExercises && existingExercises.length > 0) {
            existingExercises.forEach(ex => addExerciseCard(ex));
        }
    });

    // Botão Adicionar Manual
    document.getElementById('addExerciseBtn').addEventListener('click', () => addExerciseCard());

    // --- Lógica do Modal ---
    window.openLibraryModal = function() {
        selectedExercises.clear();
        updateSelectedCount();
        renderLibrary(libraryData);
        libraryModal.style.display = 'block';
        searchInput.value = '';
        searchInput.focus();
    }

    window.closeLibraryModal = function() {
        libraryModal.style.display = 'none';
    }

    function renderLibrary(items) {
        libraryGrid.innerHTML = '';
        if(!items || items.length === 0) {
            libraryGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Nenhum exercício encontrado.</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            // Template string JS padrão
            div.className = `lib-item ${selectedExercises.has(item.id) ? 'selected' : ''}`;
            div.onclick = () => toggleSelection(div, item.id);

            const imgHtml = item.image_url 
                ? `<img src="${item.image_url}" class="lib-img" loading="lazy">`
                : `<div class="lib-img" style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-dumbbell" style="font-size: 2rem; color: #444;"></i></div>`;

            div.innerHTML = `
                ${imgHtml}
                <div class="lib-info">
                    ${item.category ? `<span class="lib-category">${item.category}</span>` : ''}
                    <div class="lib-name">${item.name || 'Sem Nome'}</div>
                    <div class="lib-desc">${item.description || ''}</div>
                </div>
            `;
            libraryGrid.appendChild(div);
        });
    }

    function toggleSelection(el, id) {
        const idStr = String(id);
        const exists = Array.from(selectedExercises).some(x => String(x) === idStr);

        if (exists) {
            selectedExercises.forEach(x => { if(String(x) === idStr) selectedExercises.delete(x); });
            el.classList.remove('selected');
        } else {
            selectedExercises.add(id);
            el.classList.add('selected');
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedCountSpan.textContent = selectedExercises.size;
    }

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = libraryData.filter(x => 
            (x.name && x.name.toLowerCase().includes(term)) || 
            (x.category && x.category.toLowerCase().includes(term))
        );
        renderLibrary(filtered);
    });

    window.addSelectedExercises = function() {
        const selectedIds = Array.from(selectedExercises);
        if(selectedIds.length === 0) {
            alert("Selecione pelo menos um exercício.");
            return;
        }
        selectedIds.forEach(id => {
            const exerciseData = libraryData.find(x => x.id == id);
            if(exerciseData) {
                addExerciseCard(exerciseData);
            }
        });
        closeLibraryModal();
        // Scroll suave para o final
        setTimeout(() => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }, 100);
    }

    // --- Salvar (Submit) ---
    document.getElementById('editWorkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        try {
            const exercises = Array.from(document.querySelectorAll('.exercise-card')).map((card, index) => ({
                name: card.querySelector('.ex-name').value,
                sets: card.querySelector('.ex-sets').value,
                reps: card.querySelector('.ex-reps').value,
                // Concatena Descanso às notas se houver
                notes: card.querySelector('.ex-notes').value + (card.querySelector('.ex-rest').value ? ` | Descanso: ${card.querySelector('.ex-rest').value}` : ''),
                video_url: card.querySelector('.ex-video').value,
                image_url: card.querySelector('.ex-image-url').value,
                order_index: index
            }));

            if (exercises.length === 0) throw new Error('Adicione exercícios.');

            const res = await fetch('/workouts/edit/' + workoutId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
                body: JSON.stringify({
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    exercises
                })
            });

            const json = await res.json();
            if(json.success) window.location.href = `/admin/clients/${json.clientId}`;
            else throw new Error(json.message);
        } catch (err) {
            alert('Erro: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
<%- include('../partials/footer.ejs') %>
