<%- include('../partials/header.ejs', { title, bodyClass: 'dashboard-body' }) %>
<div class="dashboard-container" style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
    <%- include('../partials/sidebar.ejs', { currentPage: 'dashboard' }) %>
    <main class="dashboard-main">
        <div class="section">
            <div class="section-header"><h1>Editar Treino</h1></div>
                <div style="display:flex; gap:10px;">
                    <a href="javascript:history.back()" class="btn btn-secondary btn-sm">Voltar</a>
                    <a href="/admin/dashboard" class="btn btn-outline btn-sm">Cancelar</a>
                </div>
            
            <form id="editWorkoutForm" class="dashboard-form" style="max-width: 800px;">
                <div class="form-group">
                    <label>Título</label>
                    <input type="text" id="title" value="<%= workout.title %>" required>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="description" rows="2"><%= workout.description %></textarea>
                </div>

                <h3 style="margin: 2rem 0 1rem;">Exercícios</h3>
                <div id="exercisesContainer">
                    <% exercises.forEach((ex, index) => { %>
                        <div class="exercise-item" style="background: var(--c-bg-card); border: 1px solid var(--c-border); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <h4 style="color: var(--c-accent-primary); margin: 0;">Exercício <%= index + 1 %></h4>
                                <button type="button" class="btn btn-sm btn-outline remove-exercise" style="color: var(--c-error); border-color: var(--c-error);">Remover</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group"><label>Nome</label><input type="text" class="exercise-name" value="<%= ex.name %>" required></div>
                                <div class="form-group"><label>Séries x Reps</label><input type="text" class="exercise-sets" value="<%= ex.sets %>" required></div>
                            </div>
                            <div class="form-group"><label>Obs</label><textarea class="exercise-description" rows="1"><%= ex.notes %></textarea></div>
                            <div class="form-group"><label>Vídeo URL</label><input type="text" class="exercise-video" value="<%= ex.video_url %>"></div>
                        </div>
                    <% }) %>
                </div>
                <button type="button" class="btn btn-outline" id="addExerciseBtn" style="width: 100%; border-style: dashed;">+ Adicionar Exercício</button>
                
                <div class="form-actions" style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </main>
</div>
<script>
    // Mesma lógica de JS do create, adaptada se necessário
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('exercisesContainer');
        const addBtn = document.getElementById('addExerciseBtn');
        
        function addExercise() {
            const count = container.children.length + 1;
            const html = `
                <div class="exercise-item" style="background: var(--c-bg-card); border: 1px solid var(--c-border); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="color: var(--c-accent-primary); margin: 0;">Exercício ${count}</h4>
                        <button type="button" class="btn btn-sm btn-outline remove-exercise" style="color: var(--c-error); border-color: var(--c-error);">Remover</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group"><label>Nome *</label><input type="text" class="exercise-name" required></div>
                        <div class="form-group"><label>Séries x Reps *</label><input type="text" class="exercise-sets" required></div>
                    </div>
                    <div class="form-group"><label>Obs</label><textarea class="exercise-description" rows="1"></textarea></div>
                    <div class="form-group"><label>Vídeo URL</label><input type="text" class="exercise-video"></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }
        addBtn.addEventListener('click', addExercise);
        container.addEventListener('click', (e) => { if(e.target.classList.contains('remove-exercise')) e.target.closest('.exercise-item').remove(); });

        document.getElementById('editWorkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const exercises = [];
            document.querySelectorAll('.exercise-item').forEach(item => {
                exercises.push({
                    name: item.querySelector('.exercise-name').value,
                    sets: item.querySelector('.exercise-sets').value,
                    description: item.querySelector('.exercise-description').value,
                    video_url: item.querySelector('.exercise-video').value
                });
            });

            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                exercises: exercises
            };

            try {
                const res = await fetch(window.location.pathname, { // POST para a mesma URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
                    body: JSON.stringify(formData)
                });
                const json = await res.json();
                if (json.success) window.location.href = '/admin/clients/' + json.clientId;
                else alert('Erro: ' + json.message);
            } catch (err) { alert('Erro.'); }
        });
    });
</script>
    
    <aside class="exercises-sidebar" style="background: #111; padding: 1.5rem; border-radius: 12px; border: 1px solid #333; height: fit-content;">
        <h3 style="color: var(--c-accent-primary); margin-bottom: 1rem; font-size: 1.2rem;">Biblioteca</h3>
        <div class="search-box" style="margin-bottom: 1rem;">
            <input type="text" id="exerciseSearch" placeholder="Buscar exercício..." 
                   style="width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 6px;"
                   onkeyup="filterExercises()">
        </div>
        <div class="exercises-list" id="exercisesList" style="max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
            <% if(typeof exercises !== "undefined") { %>
                <% exercises.forEach(function(ex) { %>
                    <div class="exercise-item draggable-source" draggable="true" 
                         data-id="<%= ex.id %>" data-name="<%= ex.name %>" 
                         style="background: #222; padding: 10px; border-radius: 6px; border: 1px solid #333; cursor: grab;">
                        <strong style="color: white; font-size: 0.9rem;"><%= ex.name %></strong>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span style="font-size: 0.75rem; color: #888;"><%= ex.category %></span>
                            <button type="button" onclick="addExerciseToWorkout('<%= ex.name %>r)" style="background: var(--c-accent-primary); border: none; color: black; border-radius: 4px; padding: 2px 6px; font-weight: bold; cursor: pointer; font-size: 0.8rem;">+</button>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </aside>
    <script>
    function filterExercises() {
        const input = document.getElementById("exerciseSearch");
        const filter = input.value.toUpperCase();
        const list = document.getElementById("exercisesList");
        const items = list.getElementsByClassName("exercise-item");
        for (let i = 0; i < items.length; i++) {
            const txtValue = items[i].getAttribute("data-name");
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    }
    // Função auxiliar simples para adicionar ao container (assume que a lógica de JS existente lida com a lista)
    function addExerciseToWorkout(name) {
        // Tenta usar a função global se existir, senão alerta
        if(typeof addExercise === "function") { addExercise(name); }
        else { alert("Adicione manualmente: " + name); }
    }
    </script>
<%- include('../partials/footer.ejs') %>
