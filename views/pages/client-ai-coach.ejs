<%- include('../partials/header.ejs') %>
<div class="dashboard-container" style="height: calc(100vh - 80px);">
    <%- include('../partials/sidebar.ejs', { path: '/client/ai-coach' }) %>
    <main class="dashboard-main" style="display: flex; flex-direction: column;">
        <div class="mobile-dash-header">
            <button id="sidebarOpenBtn" class="btn btn-outline btn-sm"><i class="fas fa-bars"></i></button>
            <span>IA Coach</span>
        </div>
        
        <div class="page-header">
            <h1>Coach <span class="text-neon">Inteligente</span></h1>
            <p>Powered by Google Gemini</p>
        </div>

        <div class="card-box" style="flex: 1; display: flex; flex-direction: column; min-height: 0; padding: 0; overflow: hidden;">
            <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;">
                <div style="align-self: flex-start; background: #222; padding: 15px; border-radius: 12px; max-width: 80%;">
                    <strong class="text-neon" style="display: block; margin-bottom: 5px;">IA:</strong> 
                    Olá, <%= user.name.split(' ')[0] %>! Sou seu assistente de treino. No que posso ajudar?
                </div>
            </div>
            
            <div style="padding: 20px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px;">
                <input type="text" id="userMsg" class="form-control" placeholder="Ex: O que comer pós-treino?" style="flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #000; color: white;">
                <button onclick="sendMessage()" class="btn btn-primary" style="border-radius: 50%; width: 46px; height: 46px; padding: 0;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </main>
</div>

<script>
async function sendMessage() {
    const input = document.getElementById('userMsg');
    const msg = input.value.trim();
    if(!msg) return;

    const chatBox = document.getElementById('chatBox');
    
    // Adiciona msg do usuário
    chatBox.innerHTML += `
        <div style="align-self: flex-end; background: #bef202; color: black; padding: 12px 15px; border-radius: 12px; max-width: 80%;">
            <strong>Você:</strong> ${msg}
        </div>
    `;
    input.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;

    // Loading...
    const loadingId = 'loading-' + Date.now();
    chatBox.innerHTML += `
        <div id="${loadingId}" style="align-self: flex-start; background: #222; padding: 10px; border-radius: 12px;">
            <i class="fas fa-spinner fa-spin text-neon"></i> Digitando...
        </div>
    `;

    try {
        const res = await fetch('/client/ai-coach/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'CSRF-Token': '<%= csrfToken %>' },
            body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        
        document.getElementById(loadingId).remove();
        
        chatBox.innerHTML += `
            <div style="align-self: flex-start; background: #222; padding: 15px; border-radius: 12px; max-width: 80%;">
                <strong class="text-neon" style="display: block; margin-bottom: 5px;">IA:</strong> ${data.response}
            </div>
        `;
    } catch(err) {
        document.getElementById(loadingId).remove();
        alert('Erro ao comunicar com a IA');
    }
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Enter para enviar
document.getElementById('userMsg').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMessage();
});
</script>
<%- include('../partials/footer.ejs') %>
