<div class="notification-wrapper">
    <button class="notif-btn" id="notifBtn" type="button" onclick="toggleNotifications(event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <% if (locals.unreadCount > 0) { %>
            <span class="notif-badge"><%= unreadCount > 9 ? '9+' : unreadCount %></span>
        <% } %>
    </button>

    <div class="notif-dropdown" id="notifDropdown">
        <div class="notif-header">
            <span>Notificações</span>
            <button class="mark-all-btn" type="button" onclick="markAllRead(event)">Marcar lidas</button>
        </div>
        <div class="notif-list">
            <% if (locals.notifications && locals.notifications.length > 0) { %>
                <% notifications.forEach(n => { %>
                    <div class="notif-item <%= n.is_read ? 'read' : 'unread' %>" onclick="clickNotification('<%= n.id %>', '<%= n.link %>', this)">
                        <div class="notif-title"><%= n.title %></div>
                        <div class="notif-msg"><%= n.message %></div>
                        <div class="notif-time"><%= new Date(n.created_at).toLocaleDateString('pt-BR') %></div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="notif-empty">Nenhuma notificação recente.</div>
            <% } %>
        </div>
        <a href="/notifications" class="notif-footer">Ver todas</a>
    </div>
</div>

<script>
    // --- Lógica de Interface Otimista ---

    window.toggleNotifications = function(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        const dropdown = document.getElementById('notifDropdown');
        if(dropdown) dropdown.classList.toggle('active');
    };

    window.markAllRead = async function(e) {
        if(e) { e.preventDefault(); e.stopPropagation(); }
        
        // Remove o badge imediatamente
        const badge = document.querySelector('.notif-badge');
        if(badge) badge.remove();
        
        // Marca visualmente todos os itens como lidos
        document.querySelectorAll('.notif-item.unread').forEach(el => {
            el.classList.remove('unread');
            el.classList.add('read');
        });

        // Chama o servidor em background
        try {
            await fetch('/notifications/mark-all-read', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
        } catch(err) { console.error('Erro backend:', err); }
    };

    window.clickNotification = async function(id, link, element) {
        // 1. Atualização Visual Imediata (Antes do servidor/redirect)
        
        // Se o elemento clicado ainda estiver marcado como não lido
        if (element && element.classList.contains('unread')) {
            element.classList.remove('unread');
            element.classList.add('read');

            // Atualiza o número no ícone (Badge)
            const badge = document.querySelector('.notif-badge');
            if (badge) {
                let currentCount = parseInt(badge.innerText);
                // Se for "9+", o parseInt retorna 9. 
                
                if (!isNaN(currentCount)) {
                    let newCount = currentCount - 1;
                    
                    if (newCount <= 0) {
                        // Se chegar a 0, remove o badge
                        badge.remove();
                    } else {
                        // Senão, atualiza o texto
                        badge.innerText = newCount > 9 ? '9+' : newCount;
                    }
                }
            }
        }

        // 2. Chama o servidor para marcar como lida (sem esperar resposta para o UX ser rápido)
        fetch(`/notifications/mark-read/${id}`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        }).catch(e => console.error(e));

        // 3. Redirecionamento
        if (link && link !== 'null' && link !== '') {
            window.location.href = link;
        } else {
            // Se não tiver link, não fazemos reload para manter a alteração visual que acabamos de fazer
            // Apenas se quiser garantir sincronia total: window.location.reload();
        }
    };

    // Fechar dropdown ao clicar fora
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notifDropdown');
        const btn = document.getElementById('notifBtn');
        if (dropdown && dropdown.classList.contains('active')) {
            if (!dropdown.contains(e.target) && (!btn || !btn.contains(e.target))) {
                dropdown.classList.remove('active');
            }
        }
    });
</script>
